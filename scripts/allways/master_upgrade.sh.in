#!/bin/bash

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi
. $JMARECEIPT_ENV

#------------------------------------
# $1 : 医療機関識別番号(HOSPNUM)
# $2 : スーパーバイザー
# $3 : 医療機関識別番号(HOSPID)
# $4 : 標準マスタエラーファイル名
# $5 : 標準マスタジョブＩＤ
# $6 : 標準マスタシェルＩＤ
# $7 : ライセンスマスタエラーファイル名
# $8 : ライセンスマスタジョブＩＤ
# $9 : ライセンスマスタシェルＩＤ
#------------------------------------
HOSPNUM=$1
LOGDIR=/var/log/jma-receipt
TMPLOG=/tmp/${HOSPNUM}master-upgrade-log.$$
STARTNAME="${HOSPNUM}master-upgrade.log.gz.0"

MNTRET=0
MLIRET=0


#[ -d ${LOGDIR} ]         || mkdir -p ${LOGDIR}


if [ -f ${LOGDIR}/${STARTNAME} ];  then
	if [ $(stat -c "%s" ${LOGDIR}/${STARTNAME}) -ge 1048576 ] ; then
		for NUM in `seq 3 -1 1`
		do
		  NEWNAME="${STARTNAME%.*}.${NUM}"
		  NUM=`expr ${NUM} - 1`
		  OLDNAME="${STARTNAME%.*}.${NUM}"
		  mv ${LOGDIR}/${OLDNAME} ${LOGDIR}/${NEWNAME} 2>/dev/null
		done
	fi
fi

#標準マスタ更新
master_standard_upgrade.sh $1 $2 $4 $5 $6 2>&1 | tee ${TMPLOG}
MNTRET=$?
if [ ${MNTRET} -ne 1 ]; then
    #ライセンスマスタ更新
    sleep 1
    master_license_upgrade.sh $1 $2 $3 $7 $8 $9 2>&1 | tee -a ${TMPLOG}
    MLIRET=$?
fi

gzip -c ${TMPLOG} >> ${LOGDIR}/${STARTNAME}
rm -f ${TMPLOG}

exit $(expr ${MNTRET} + ${MLIRET})
