#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#-------------------------------------------#
#    患者一覧出力
#        $1  処理区分
#        $2  CSVファイル名
#        $3  パラメータファイル名
#        $4  TERMID
#        $5  SYSYMD
#        $6  SYSDATE
#        $7  HOSPNUM
#        $8  STAFFCD
#        $9  ジョブＩＤ
#        $10 シェルＩＤ
#        $11 ファイル出力先 1:client
#        $12 文字コード区分 1:euc 2:s-jis
#        $13 FILENM FOLDER
#        $14 FILENM 
#        $15 WKCSVファイル名
#        $16 検索パターン 0:通常/1:点数/2:診療行為
#
#-------------------------------------------#

        OLDLOG="/var/log/jma-receipt/${7}ORCBQ01.log"
        LOG_FILE="/var/log/jma-receipt/${7}orcb013_1.log"

[ -e "${OLDLOG}" ] &&  rm ${OLDLOG}
[ -e "${LOG_FILE}" ] &&  rm ${LOG_FILE}

        echo "all params [" $@ "]"   >$LOG_FILE
        echo "arg2   = [" ${2}   "]" <>$LOG_FILE
        echo "arg11  = [" ${11}  "]" >>$LOG_FILE
        echo "arg12  = [" ${12}  "]" >>$LOG_FILE
##
        PGNAME=ORCBQ01
        [ ${16} == "1" ] && PGNAME=ORCBQ01A
        [ ${16} == "2" ] && PGNAME=ORCBQ01B
##
        $DBSTUB -dir $LDDIRECTORY -bd orcabt ${PGNAME} -parameter $3,$4,$5,$6,$7,$8,${11},${13},${14},${15},${16} >> $LOG_FILE 2>&1

##      ＣＳＶファイル作成
        if  [ $1 -eq "0" ]; then
            if  [ -e ${15} ]; then
		ruby -e 'STDIN.readlines.each{|y| puts y.split(",").each{|x|  x.strip!}.join(",")}' <  ${15} > ${2}.tmp

                if   [ ${11} = '1' ]; then
#                   クライアント保存のとき固定ファイルに文字コード変換（ＥＵＣからＳ−ｊｉｓ）
                    if  [ ${12} = '2' ]; then
                        nkf -s -Lw ${2}.tmp > ${15}
                        rm  ${2}.tmp
                    else 
                        mv  ${2}.tmp ${15}
                    fi
                else
                    mv  ${2}.tmp $2
                    rm  ${15}
                fi 
            fi
        fi

##      パラメータファイル削除
        if  [ -e $3 ]; then
            rm  $3
        fi

       $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter "JBE$9${10},$7" >> $LOG_FILE 2>&1

        exit
