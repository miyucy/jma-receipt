#!/bin/bash
#
# jma-receipt ver5.1.0
# 
# バージョンアップによる移行処理
#
# データ移行処理

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

# TODO
# dbstub のリザルトコードの扱いとログ出力

#------------------------------------
# $1 : 医療機関識別番号(HOSPNUM)
# $2 : ジョブＩＤ
# $3 : シェルＩＤ
#------------------------------------

HOSPNUM=${1}
LDDIRECTORY=${LDDEFDIR}/dirmigv51

# 住所テーブル

echo "住所テーブルを開始します。"
SQL="SELECT COUNT(*) FROM tbl_adrs_user WHERE hospnum=${HOSPNUM};"
RCNT=`psql ${DBCONNOPTION} ${DBNAME} -Atqc "${SQL}"`
if [ ${RCNT} -gt 0 ]; then
  echo "tbl_adrs_user (hospnum=${HOSPNUM}) はレコードが存在するため処理をスキップしました。"
else
  PROID=ORCBMIGADRS
  LIMITTER=`printf "%05d" 0`
  PRFFILE="${LOGDIR}/${HOSPNUM}${PROID}-prf.csv"
  PARAM="${HOSPNUM},${LIMITTER},${PRFFILE},"
  ${DBSTUB} -dir ${LDDIRECTORY} -bd migv51 ${PROID} -parameter "${PARAM}" 2>&1 | nkf -Ewu
  RC=${PIPESTATUS[0]}
  chmod 644 ${PRFFILE}
  if [ ${RC} = 0 ]; then
    echo "住所テーブルは終了しました。"
  else
    echo " "
    echo "******************************************"
    echo "住所テーブルの移行処理は異常終了しました。"
    echo "******************************************"
    echo " "
    exit 1
  fi
fi

# チェックテーブル

echo "チェックテーブルを開始します。"
SQL="SELECT COUNT(*) FROM tbl_chk_user WHERE hospnum=${HOSPNUM};"
RCNT=`psql ${DBCONNOPTION} ${DBNAME} -Atqc "${SQL}"`
if [ ${RCNT} -gt 0 ]; then
  echo "tbl_chk_user (hospnum=${HOSPNUM}) はレコードが存在するため処理をスキップしました。"
else
  PROID=ORCBMIGCHK
  LIMITTER=`printf "%05d" 0`
  PRFFILE="${LOGDIR}/${HOSPNUM}${PROID}-prf.csv"
  PARAM="${HOSPNUM},${LIMITTER},${PRFFILE},"
  ${DBSTUB} -dir ${LDDIRECTORY} -bd migv51 ${PROID} -parameter "${PARAM}" 2>&1 | nkf -Ewu
  RC=${PIPESTATUS[0]}
  chmod 644 ${PRFFILE}
  if [ ${RC} = 0 ]; then
    echo "チェックテーブルは終了しました。"
  else
    echo " "
    echo "**********************************************"
    echo "チェックテーブルの移行処理は異常終了しました。"
    echo "**********************************************"
    echo " "
    exit 1
  fi
fi

# 保険者テーブル

echo "保険者テーブルを開始します。"
SQL="SELECT COUNT(*) FROM tbl_hknjainf_user WHERE hospnum=${HOSPNUM};"
RCNT=`psql ${DBCONNOPTION} ${DBNAME} -Atqc "${SQL}"`
if [ ${RCNT} -gt 0 ]; then
  echo "tbl_hknjainf_user (hospnum=${HOSPNUM}) はレコードが存在するため処理をスキップしました。"
else
  PROID=ORCBMIGHKNJAINF
  LIMITTER=`printf "%05d" 0`
  PRFFILE="${LOGDIR}/${HOSPNUM}${PROID}-prf.csv"
  PARAM="${HOSPNUM},${LIMITTER},${PRFFILE},"
  ${DBSTUB} -dir ${LDDIRECTORY} -bd migv51 ${PROID} -parameter "${PARAM}" 2>&1 | nkf -Ewu
  RC=${PIPESTATUS[0]}
  chmod 644 ${PRFFILE}
  if [ ${RC} = 0 ]; then
    echo "保険者テーブルは終了しました。"
  else
    echo " "
    echo "********************************************"
    echo "保険者テーブルの移行処理は異常終了しました。"
    echo "********************************************"
    echo " "
    exit 1
  fi
fi

# 一般老人置換テーブル

echo "一般老人置換テーブルを開始します。"
SQL="SELECT COUNT(*) FROM tbl_srycdchg_user WHERE hospnum=${HOSPNUM};"
RCNT=`psql ${DBCONNOPTION} ${DBNAME} -Atqc "${SQL}"`
if [ ${RCNT} -gt 0 ]; then
  echo "tbl_srycdchg_user (hospnum=${HOSPNUM}) はレコードが存在するため処理をスキップしました。"
else
  PROID=ORCBMIGSRYCDCHG
  LIMITTER=`printf "%05d" 0`
  PRFFILE="${LOGDIR}/${HOSPNUM}${PROID}-prf.csv"
  PARAM="${HOSPNUM},${LIMITTER},${PRFFILE},"
  ${DBSTUB} -dir ${LDDIRECTORY} -bd migv51 ${PROID} -parameter "${PARAM}" 2>&1 | nkf -Ewu
  RC=${PIPESTATUS[0]}
  chmod 644 ${PRFFILE}
  if [ ${RC} = 0 ]; then
    echo "一般老人置換テーブルは終了しました。"
  else
    echo " "
    echo "**************************************************"
    echo "一般老人置換テーブルの移行処理は異常終了しました。"
    echo "**************************************************"
    echo " "
    exit 1
  fi
fi

# 点数テーブル

echo "点数テーブルを開始します。"
SQL="SELECT COUNT(*) FROM tbl_tensu_user WHERE hospnum=${HOSPNUM} AND SUBSTR(srycd,1,1) <> '0';"
RCNT=`psql ${DBCONNOPTION} ${DBNAME} -Atqc "${SQL}"`
if [ ${RCNT} -gt 0 ]; then
  echo "tbl_tensu_user (hospnum=${HOSPNUM}) はレコードが存在するため処理をスキップしました。"
else
  PROID=ORCBMIGTENSU
  LIMITTER=`printf "%05d" 0`
  PRFFILE="${LOGDIR}/${HOSPNUM}${PROID}-prf.csv"
  PARAM="${HOSPNUM},${LIMITTER},${PRFFILE},"
  ${DBSTUB} -dir ${LDDIRECTORY} -bd migv51 ${PROID} -parameter "${PARAM}" 2>&1 | nkf -Ewu
  RC=${PIPESTATUS[0]}
  chmod 644 ${PRFFILE}
  if [ ${RC} = 0 ]; then
    echo "点数テーブルは終了しました。"
  else
    echo " "
    echo "******************************************"
    echo "点数テーブルの移行処理は異常終了しました。"
    echo "******************************************"
    echo " "
    exit 1
  fi
fi

# 点数付加テーブル

echo "点数付加テーブルを開始します。"
PROID=ORCBMIGTENSUPLUS
PARAM="${HOSPNUM},"
${DBSTUB} -dir ${LDDIRECTORY} -bd migv51 ${PROID} -parameter "${PARAM}" 2>&1 | nkf -Ewu
RC=${PIPESTATUS[0]}
if [ ${RC} = 0 ]; then
  echo "点数付加テーブルは終了しました。"
else
  echo " "
  echo "**********************************************"
  echo "点数付加テーブルの移行処理は異常終了しました。"
  echo "**********************************************"
  echo " "
  exit 1
fi

exit 0
