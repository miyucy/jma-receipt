#!/bin/bash

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#-------------------------------------------#
#    データチェク処理
#        $1    医療機関番号
#        $2-${12} 印刷ＤＢ用固定引数
#        ${13} ジョブＩＤ
#        ${14} シェルＩＤ
#        ${15} 医療機関番号
#        ${16} エラーファイル名 
#        ${17} 一括・個別区分
#        ${18} 診療年月
#        ${19} 入外区分
#        ${20} チェック区分×５０
#        ${21} 社保の処理区分
#        ${22} 国保の処理区分
#        ${23} 労災の処理区分
#        ${24} 自賠責の処理区分
#        ${25} 自費保険の処理区分
#        ${26} 院外処方の処理区分
#        ${27} 印刷順
#        ${28} 患者別リストの作成区分
#        ${29} 診療日指定区分
#        ${30} 診療日指定開始日
#        ${31} 診療日指定終了日
#        ${32} 公害保険の処理区分
#        ${33} 後期高齢者の処理区分
#        ${34} 治験の処理区分
#        ${35} 第三者行為の処理区分
#-------------------------------------------#

OLDLOG=/home/orca/orcbsd01.log
LOGFILE="/var/log/jma-receipt/${15}orcb041.log"

for p in $(pgrep -f "$0 $1" ) ; do
  if [ $p -ne $$ ]; then
    pkill -P $p
  fi
done


##      旧ログファイルを削除
        if  [ -e $OLDLOG ]; then
            rm  $OLDLOG
        fi


##      エラーファイル削除
        if  [ -e ${16} ]; then
            rm  ${16}
        fi

        $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCDTCHK000 -parameter "$2,$3,$4,$5,$6,$7,$8,$9,${10},${11},${12},${13},${14},${15},${16},${17},${18},${19},${20},${21},${22},${23},${24},${25},${26},${27},${28},${29},${30},${31},${32},${33},${34},${35}"   > $LOGFILE 2>&1
        if  [ -e ${16} ]; then
            exit
        fi

if [ $(pgrep -fn "$0 $1") -eq $$ ] ; then

        $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${13}${14},${15}

##      作業ファイル削除
        rm /tmp/${15}00DTCHK*.dat
        rm /tmp/${15}00DCACCT*.dat
        rm /tmp/${15}00DCSRY*.dat
        rm /tmp/${15}00DCSANTEI*.dat
fi

exit
