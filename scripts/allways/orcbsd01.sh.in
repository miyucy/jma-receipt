#!/bin/bash

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#-------------------------------------------#
#    データチェク処理
#        $1    テナント番号
#        $2    医療機関番号
#        $3-${13} 印刷ＤＢ用固定引数
#        ${14} ジョブＩＤ
#        ${15} シェルＩＤ
#        ${16} 医療機関番号
#        ${17} エラーファイル名 
#        ${18} 一括・個別区分
#        ${19} 診療年月
#        ${20} 入外区分
#        ${21} チェック区分×５０
#        ${22} 社保の処理区分
#        ${23} 国保の処理区分
#        ${24} 労災の処理区分
#        ${25} 自賠責の処理区分
#        ${26} 自費保険の処理区分
#        ${27} 院外処方の処理区分
#        ${28} 印刷順
#        ${29} 患者別リストの作成区分
#        ${30} 診療日指定区分
#        ${31} 診療日指定開始日
#        ${32} 診療日指定終了日
#        ${33} 公害保険の処理区分
#        ${34} 後期高齢者の処理区分
#        ${35} 治験の処理区分
#        ${36} 第三者行為の処理区分
#-------------------------------------------#

LOGFILE="/var/log/jma-receipt/${16}orcb041.log"

killtree(){
  local children=$(pgrep -P $1 2>/dev/null)
  for child in ${children} ; do
    killtree ${child}
  done
  kill -9 $1
}

for p in $(pgrep -f "$0 $1 $2" ) ; do
  if [ $p -ne $$ ]; then
    killtree $p
  fi
done

ERR_FILE_BASE=${17}
ERR_FILE_FULL=${MCP_TEMPDIR}/${ERR_FILE_BASE}


##      エラーファイル削除
        if  [ -e ${ERR_FILE_FULL} ]; then
            rm  ${ERR_FILE_FULL}
        fi

        $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCDTCHK000 -parameter "$3,$4,$5,$6,$7,$8,$9,${10},${11},${12},${13},${14},${15},${16},${17},${18},${19},${20},${21},${22},${23},${24},${25},${26},${27},${28},${29},${30},${31},${32},${33},${34},${35},${36}"   > $LOGFILE 2>&1
        if  [ -e ${ERR_FILE_FULL} ]; then
            exit
        fi

if [ $(pgrep -fn "$0 $1 $2") -eq $$ ] ; then

        $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${14}${15},${16}

##      作業ファイル削除
        rm ${MCP_TEMPDIR}/${16}00DTCHK*
        rm ${MCP_TEMPDIR}/${16}00DCACCT*
        rm ${MCP_TEMPDIR}/${16}00DCSRY*
        rm ${MCP_TEMPDIR}/${16}00DCSANTEI*
fi

exit
