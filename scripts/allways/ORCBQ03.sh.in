#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

OLDLOG=/var/log/jma-receipt/"$2"ORCBQ03.log
LOG=/var/log/jma-receipt/"$2"orcb013_3.log

[ -e "${OLDLOG}" ] &&  rm ${OLDLOG}
[ -e "${LOG}" ] &&  rm ${LOG}


#-------------------------------------------#
#        検索結果データ作成
#        $1  TERMID
#        $2  HOSPNUM
#        $3  パラメータファイル名
#        $4  処理日
#        $5  処理時間
#-------------------------------------------#

PARA_FILE_BASE=$3
PARA_FILE_FULL=${MCP_TEMPDIR}/${PARA_FILE_BASE}

cleanup(){
echo "${PARA_FILE_FULL}" >> $LOG
##      パラメータファイル削除
        if  [ -e ${PARA_FILE_FULL} ]; then
            rm   ${PARA_FILE_FULL}
        fi
}

killtree(){
  local children=$(pgrep -P $1 2>/dev/null)
  for ${child} in ${children} ; do
    killtree ${child}
  done
  kill -9 $1
}


trap cleanup 0

for p in $(pgrep -u orca -f "$0 $1" ) ; do
  if [ $p -ne $$ ]; then
    killtree $p
  fi
done

n=1
while [ $n -lt 3 ] ; do
    n=$(expr $n + 1)
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBQ03 -parameter "$1,$2,${PARA_FILE_BASE},$4,$5,"  > $LOG 2>&1
    [ $? -eq 0 ] && break
    sleep 3
done

        exit

