#!/bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

case "$1" in
  daily)
    PATH=$SITESCRIPTSDIR/daily:$PATCHSCRIPTSDIR/daily:$SCRIPTSDIR/daily:$PATH
    ;;
  monthly)
    PATH=$SITESCRIPTSDIR/monthly:$PATCHSCRIPTSDIR/monthly:$SCRIPTSDIR/monthly:$PATH
    ;;
  allways)
    PATH=$SITESCRIPTSDIR/allways:$PATCHSCRIPTSDIR/allways:$SCRIPTSDIR/allways:$PATH
    ;;
  shell)
    PATH=$PATH
    ;;
  *)
    exit 1
    ;;
esac

export PATH

LOGSH="log_shell.sh"
LOGSHDIR=$SCRIPTSDIR/allways
[ -e ${PATCHSCRIPTSDIR}/allways/${LOGSH} ] && LOGSHDIR=${PATCHSCRIPTSDIR}/allways
[ -e ${SITESCRIPTSDIR}/allways/${LOGSH} ]  && LOGSHDIR=${SITESCRIPTSDIR}/allways

${LOGSHDIR}/${LOGSH} "$$" "ST" "$@" &

termtrap () {
  echo "term trap in ${0}."
  ${LOGSHDIR}/${LOGSH} "$$" "ED" "$@" &
  exit 1
}

trap 'termtrap "$@"' TERM

export R_PID=`ps -o ppid --no-headers -p $$`

bash -c "$2 \"$3\" \"$4\" \"$5\" \"$6\" \"$7\" \"$8\" \"$9\" \"${10}\" \"${11}\" \"${12}\" \"${13}\" \"${14}\" \
        \"${15}\" \"${16}\" \"${17}\" \"${18}\" \"${19}\" \"${20}\" \"${21}\" \"${22}\" \"${23}\" \"${24}\" \
        \"${25}\" \"${26}\" \"${27}\" \"${28}\" \"${29}\" \"${30}\" \"${31}\" \"${32}\" \"${33}\" \"${34}\" \
        \"${35}\" \"${36}\" \"${37}\" \"${38}\" \"${39}\" \"${40}\" \"${41}\" \"${42}\""
RET=$?

${LOGSHDIR}/${LOGSH} "$$" "ED" "$@" &

exit ${RET}
