#!/bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

HOSPNUM=$1
HOSPID=$2

export CLIENT_CONFIG_FILE="$SYSCONFDIR/das-upload.d/das-upload${HOSPNUM}.conf"
if [ ! -f $CLIENT_CONFIG_FILE ]; then
    exit
fi
export DAS_CHECK_HOSPID=$HOSPID

FILE_PREFIX="collect-"
UPLOAD_COMMAND=`dirname $0`/das-upload.rb
LOGFILE=$LOGDIR/"$HOSPNUM"datacollect1.log

for file in `ls "$DASDIR"/"$HOSPNUM"/"$FILE_PREFIX"*tar.gz 2>/dev/null`
do
  UPTARGEFILE=1
  OBJECTYYM=`basename $file |sed -e "s/${FILE_PREFIX}\(.*\).tar.gz/\1/"`
  RESULT=`$UPLOAD_COMMAND -t $file 2>&1|head -1`
  if [ "UP $file" = "$RESULT" ]; then
     echo "000" $RESULT
     $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOBLOG -parameter "das-upload","2","0",$OBJECTYYM,"000","Upload success",$HOSPNUM 2>&1 | tee -a $LOGFILE
     rm $file
  else
     $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOBLOG -parameter "das-upload","2","1",$OBJECTYYM,"${RESULT:0:3}","${RESULT:4:200}",$HOSPNUM 2>&1 | tee -a $LOGFILE
     echo "${RESULT:0:3}","${RESULT:4}"
  fi
  sleep 1
done

if [ x$UPTARGEFILE != "x1" ]; then
  RESULT="900 No file"
  echo "${RESULT:0:3}","${RESULT:4}"
fi
