#!/bin/sh

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#-------------------------------------------#
#    収集データ作成
#        $1  TERMID
#        $2  HOSPID
#        $3  PREFNUM
#        $4  SRYYM
#        $5  BEDFLG (0:病床なし、1:病床あり）
#        $6  JOBID
#        $7  SHELLID
#-------------------------------------------#

COLLECTG=collectg.csv
COLLECTN=collectn.csv
#                                collect-yyyymm.tar.gz (collectg.csv,collectn.csv)
LOGFILE=/home/orca/datacollect1.log
ERRFILE=/tmp/datacollecterror

DASUPLOAD=$SCRIPTSDIR/monthly/das-upload.sh

#   エラーファイル削除
    if  [ -e $ERRFILE ]; then
	rm -f $ERRFILE
    fi

    rm -f /var/tmp/COLDT*

#   外来分処理

    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBC010 -parameter $1,$2,$3,$4,2,$6,$7,$ERRFILE 2>&1 | tee $LOGFILE
    if  [ -e $ERRFILE ]; then
	rm -f /var/tmp/COLDT*
	exit
    else
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBC020 -parameter $1,$4,$6,$7,/tmp/$COLLECTG,$ERRFILE 2>&1 | tee -a $LOGFILE
	if  [ -e $ERRFILE ]; then
	    rm -f /var/tmp/COLDT*
	    exit 
	fi
    fi

    if  [ $5 -eq '1' ]; then

#   入院分処理

	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBC010 -parameter $1,$2,$3,$4,1,$6,$7,$ERRFILE 2>&1 | tee $LOGFILE
	if  [ -e $ERRFILE ]; then
	    rm -f /var/tmp/COLDT*
	    exit
	else
	    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBC020 -parameter $1,$4,$6,$7,/tmp/$COLLECTN,$ERRFILE 2>&1 | tee -a $LOGFILE
	    if  [ -e $ERRFILE ]; then
		rm -f /var/tmp/COLDT*
		exit 
	    fi
	fi
    fi

    if  [ $5 -eq '1' ]; then
	tar cvfz $DASDIR/collect-$4.tar.gz /tmp/$COLLECTG /tmp/$COLLECTN
	rm -f /tmp/$COLLECTG
	rm -f /tmp/$COLLECTN
    else
	tar cvfz $DASDIR/collect-$4.tar.gz /tmp/$COLLECTG
	rm -f /tmp/$COLLECTG
    fi

    rm -f /var/tmp/COLDT*

    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE$6$7 2>&1 | tee -a $LOGFILE

    $DASUPLOAD &

    exit
