#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV
export HOME=/home/orca
export PATH=$SITESCRIPTSDIR/daily:$PATCHSCRIPTSDIR/daily:$SCRIPTSDIR/daily:$PATH

#if ! test -d /var/tmp/.orca_ps ; then
#    mkdir /var/tmp/.orca_ps
#fi

#----------------------------------------------------------------------#
#       引数	
#       1:DATAファイル名称
#       2:HOSPNUM
#       3:エンコーディング(1:EUC-JP/2:UTF8/3:OTHER)
#       4:DATAファイル名称(オリジナル)
#----------------------------------------------------------------------#

	echo	`date`
	echo $#
	echo	$1
#whether encoding is utf-8 or not.
if [ "$3"  == '2' ]; then
	export	RED2PS_OUTPUT_CHARSET=UTF-8
else
	export	RED2PS_OUTPUT_CHARSET=EUC-JP
fi

	ruby "$SCRIPTSDIR"/daily/print_parent_prv.rb "/var/tmp/temp.tmp" "ruby ${SCRIPTSDIR}/daily/print-data.rb " ${FORMDIR} ${RECORDDIR} ${SITEFORMDIR} ${SITERECORDDIR} $1 "ruby ${SCRIPTSDIR}/daily/print-data_prv.rb " "ruby ${SCRIPTSDIR}/daily/orcred2ps.rb " ${PATCHFORMDIR}

	if	[ $?  =  0 ]; then
        	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBPREV -parameter $1,$2
	fi
	rm -f $1
        if [ -z "$4" ]  ; then
                echo "HCALL end"
                exit
        fi
        if [ ${4:0:4} = "/tmp" ] ; then
#------ 処方せんQRイメージ削除
	if      [ ${4:7:4} = "HC2Q" ]   ;then
		ruby -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' ${4} | xargs rm -f
	fi
	if      [ ${4:7:4} = "HC62" ]   ;then
                LDATA=`ls \`echo $4 | sed 's/[[:digit:]]*\.dat$//g'\`* | sort -r | head -n 1`
                ruby -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' $LDATA |xargs rm -f

	fi
	rm ${4:0:53}*
#	rm ${4}
	fi

	echo	`date`
