#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

export HOME=/home/orca

ruby -e "puts File.readlines(ARGV[0]).at(0).chomp + ' ' * 20000  " $4 > $4.tmp
mv $4.tmp $4
LAYEROPTION=`ruby -ne '$_.scan(/MonpeLayerIn(.*)MonpeLayerOut/){ print $1 }' $4`
ruby -ne 'print $_.gsub(/MonpeLayerIn(.*)MonpeLayerOut/){|s| " " * s.length } ' $4 > $4.tmp
mv $4.tmp $4

#
#-------> path switch st
file=`basename ${2}`
patch_file=$PATCHFORMDIR/$file
normal_file=$FORMDIR/$file
site_file=$SITEFORMDIR/$file
usr_form=$2

if ! test -f $site_file
then
  if test -f $patch_file
  then
    usr_form=$patch_file
  fi
fi
#-------> path switch ed
#whether encoding is utf-8 or not.
if [ "$8"  == '2' ]; then
	export	RED2PS_OUTPUT_CHARSET=UTF-8
else
	export	RED2PS_OUTPUT_CHARSET=EUC-JP
fi
	if	[ $1 = 'red2ps' ]	;then
		if	[ -z $6  ]	;then
			OFFSETX=0
		else
			OFFSETX=$6
		fi
		if	[ -z $7  ]	;then
			OFFSETY=0
		else
			OFFSETY=$7
		fi
		if	[ -z $5  ]	;then
			$1 $usr_form $4 $LAYEROPTION -x $OFFSETX -y $OFFSETY -p lp1
		else
			$1 $usr_form $4 $LAYEROPTION -x $OFFSETX -y $OFFSETY -p $5
		fi
	else	
		ruby $1 $2 $3 $4 $5
	fi
#----------------------------------------------------------------------#
#	ファイル削除処理
#----------------------------------------------------------------------#
HCLIST="HC04 HC08 HC18 HC20 HC21 HC22 HC23 HC24"
  for FL in $HCLIST
  do
	if	[ $FL = ${4:9:4} ]	;then
                 echo ${4:9:4}
		exit
	fi
  done
  if [ -e $4 ]	;then
        echo $4
#------ 処方せんQRイメージ削除
	if	[ ${4:7:4} = "HC2Q" ]	;then
	    ruby -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' $4 | xargs rm -f
	fi
	if	[ ${4:7:4} = "HC62" ]	;then
	    ruby -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' $4 | xargs rm -f
	fi
	rm $4
  fi
#----------------------------------------------------------------------#
#	終了処理
#----------------------------------------------------------------------#
	echo "The end"
exit $RET
