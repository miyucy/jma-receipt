#!/bin/bash

LOGFILE=/var/log/jma-receipt/${0%.sh}.log
RUNDATE=$(date  '+%Y%m%d%H%M%S')

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

export PATH=${SITESCRIPTSDIR}/allways:${PATCHSCRIPTSDIR}/allways:${SCRIPTSDIR}/allways:$PATH

export COB_LIBRARY_PATH=${PATCHLIBDIR}:${ORCALIBDIR}:/usr/lib/panda

DBUSER="orca"

if [ `whoami` != "${DBUSER}" ]; then
    echo   "${DBUSER}ユーザーで実行してください。"
    exit 101
fi

pgrep aps > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo   "日レセが起動していません。"
    exit 102
fi

#HOSPNUM=01
SQL="select hospnum from tbl_sysbase;"
HNLIST=`psql ${DBUSER} -t -A -q -c "${SQL}"`

for hospnum in ${HNLIST} ; do
  HOSPNUM=`printf "%02d" $hospnum`

  MNTERRFL=/tmp/${HOSPNUM}MNTERR-${RUNDATE}.$$
  MLIERRFL=/tmp/${HOSPNUM}MLIERR-${RUNDATE}.$$
  HOSPIDFL=/tmp/${HOSPNUM}HODPID-${RUNDATE}.$$

  if [	-e ${MNTERRFL}	];	then 
    rm ${MNTERRFL}
  fi

  if [	-e ${MLIERRFL}	];	then 
    rm ${MLIERRFL}
  fi

  if [	-e ${HOSPIDFL}	];	then 
    rm ${HOSPIDFL}
  fi

  ${DBSTUB} -dir ${LDDIRECTORY} -bd orcabt ORCBCHECKREDL -parameter "${MNTERRFL}"
  if [	-e ${MNTERRFL}	];	then 
    cat ${MNTERRFL}
    rm ${MNTERRFL}
    exit 103
  fi

  ${DBSTUB} -dir ${LDDIRECTORY} -bd orcabt ORCBMNT01 -parameter "${HOSPNUM},${MNTERRFL},${HOSPIDFL}"
  if [	-e ${MNTERRFL}	];	then 
    cat ${MNTERRFL}
    rm ${MNTERRFL}
    exit 104
  fi

  if [	-e ${HOSPIDFL}	];	then 
    HOSPID=$(cat ${HOSPIDFL})
    rm ${HOSPIDFL}
  else
    echo   "HOSPIDが取得できませんでした。"
    exit 105
  fi

  master_upgrade.sh "${HOSPNUM}" "T" "${HOSPID}" "${MNTERRFL}" "0000001" "MSTMNT" "${MLIERRFL}" "0000001" "MSTMLI"
  MSTMNT=$?

  if [ ${MSTMNT} -ne 0 ]; then
    exit ${MSTMNT}
  fi
done

exit ${MSTMNT}
