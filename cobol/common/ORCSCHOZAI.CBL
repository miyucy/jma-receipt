      *******************************************************************
      * Project code name "ORCA"
      * 日医標準レセプトソフト（JMA standard receipt software）
      * Copyright(C) 2002 JMA (Japan Medical Association)
      *
      * This program is part of "JMA standard receipt software".
      *
      *     This program is distributed in the hope that it will be useful
      * for further advancement in medical care, according to JMA Open
      * Source License, but WITHOUT ANY WARRANTY.
      *     Everyone is granted permission to use, copy, modify and
      * redistribute this program, but only under the conditions described
      * in the JMA Open Source License. You should have received a copy of
      * this license along with this program. If not, stop using this
      * program and contact JMA, 2-28-16 Honkomagome, Bunkyo-ku, Tokyo,
      * 113-8621, Japan.
      ********************************************************************
       IDENTIFICATION              DIVISION.
       PROGRAM-ID.                 ORCSCHOZAI.
      *****************************************************************
      *  システム名        : ＯＲＣＡ
      *  サブシステム名    : 入院会計照会
      *  コンポーネント名  : 入院用入院調剤料更新処理
      *  管理者            : 
      *  作成日付    作業者        記述
      *  03/01/10    NACL−多々納  新規作成
      *****************************************************************
      *  プログラム修正履歴
      * Maj/Min/Rev  修正者       日付      内容
      *****************************************************************
      *
      *
       ENVIRONMENT                 DIVISION.
       CONFIGURATION               SECTION.
       INPUT-OUTPUT                SECTION.
       FILE-CONTROL.
      *
      *
       DATA                    DIVISION.
      *FILE                        SECTION.
      *
      *
       WORKING-STORAGE             SECTION.
      *
      *    フラグ領域
       01  FLG-AREA.
           03  FLG-END             PIC 9(01).
           03  FLG-SRYACT          PIC 9(01).
           03  FLG-SRYACCT         PIC 9(01).
           03  FLG-PTINF           PIC 9(01).
           03  FLG-TENSU           PIC 9(01).
           03  FLG-NYUINACCT       PIC 9(01).
           03  FLG-PTNYUINRRK      PIC 9(01).
      *
           03  FLG-ARI             PIC 9(01).
           03  FLG-MADOKU          PIC 9(01).
      *
           03  FLG-OK              PIC 9(01).
      *
           03  FLG-SYORI           PIC 9(01).
           03  FLG-CHK             PIC 9(01).
      *
      *    添字領域
       01  IDX-AREA.
           03  IDX                 PIC 9(04).
           03  IDX1                PIC 9(04).
           03  IDX2                PIC 9(04).
           03  IDX3                PIC 9(04).
           03  IDY                 PIC 9(04).
      *
           03  IDX-T               PIC 9(04).
           03  IDX-H               PIC 9(04).
           03  IDX-D               PIC 9(02).
           03  IDY2                PIC 9(02).
      *
           03  IDX-S               PIC 9(02).
           03  IDX-E               PIC 9(02).
      *
      *    一時領域
       01  WRK-AREA.
           03  WRK-SYMD.
               05  WRK-SYY         PIC 9(04).
               05  WRK-SMM         PIC 9(02).
               05  WRK-SDD         PIC 9(02).
           03  WRK-WYMD.
               05  WRK-WGO         PIC X(01).
               05  WRK-WYY         PIC 9(02).
               05  WRK-WMM         PIC 9(02).
               05  WRK-WDD         PIC 9(02).
      *
           03  WRK-DD              PIC 9(02).
           03  WRK-MAX             PIC 9(02).
      *
           03  WRK-SRYCD               PIC X(09).
           03  WRK-SRYCD-9             PIC 9(09).
      *
      *    末日
           03  WRK-MATU                PIC 9(02).
           03  WRK-SRYYM.
               05  WRK-SRYYY           PIC 9(04).
               05  WRK-SRYMM           PIC 9(02).
           03  WRK-SRYKBN              PIC X(02).
           03  WRK-KAISU               PIC 9(03).
      *
           03  WRK-IDX2                PIC 9(04).
           03  WRK-SRYKA               PIC X(02).
           03  WRK-SRYSYUKBN           PIC X(03).
           03  WRK-HKNCOMBI            PIC X(04).
           03  WRK-ZAINUM              PIC 9(08).
           03  WRK-DAY-AREA.
               05  WRK-DAY-TBL         OCCURS   4.
                    07  WRK-DAY        PIC 9(03)
                                           OCCURS  31.
      *
      *    投薬日
       01  TBL-TOUYAKU-AREA.
           03  TBL-TOUYAKU-OCC1        OCCURS   2.
               05  TBL-TOUYAKU-OCC         OCCURS   31.
                   07  TBL-TOU-DAY         PIC 9(01).
                   07  TBL-TOU-AREA        OCCURS   10.
                       09  TBL-TOU-SRYKA       PIC X(02).
                       09  TBL-TOU-HKNCOMBI    PIC X(04).
               05  TBL-DOKUYAKU-OCC        OCCURS   31.
                   07  TBL-DOK-DAY         PIC 9(01).
                   07  TBL-DOK-AREA        OCCURS   10.
                       09  TBL-DOK-SRYKA       PIC X(02).
                       09  TBL-DOK-HKNCOMBI    PIC X(04).
      *    調剤料
       01  TBL-CHOZAI-AREA.
           03  TBL-CHOZAI-OCC         OCCURS   10.
               05  TBL-CHO-ZAINUM          PIC 9(08).
               05  TBL-CHO-SRYKA           PIC X(02).
               05  TBL-CHO-HKNCOMBI        PIC X(04).
               05  TBL-CHO-ADD             PIC X(01).
      *        作成
               05  TBL-CHO-DAY-AREA.
                   07  TBL-CHO-DAY-TBL     OCCURS   4.
                        09  TBL-CHO-DAY    PIC 9(03)
                                           OCCURS  31.
      *    麻毒料
       01  TBL-MADOKU-AREA.
           03  TBL-MADOKU-OCC         OCCURS   10.
               05  TBL-MAD-ZAINUM          PIC 9(08).
               05  TBL-MAD-SRYKA           PIC X(02).
               05  TBL-MAD-HKNCOMBI        PIC X(04).
               05  TBL-MAD-ADD             PIC X(01).
      *        作成
               05  TBL-MAD-DAY-AREA.
                   07  TBL-MAD-DAY-TBL     OCCURS   4.
                        09  TBL-MAD-DAY    PIC 9(03)
                                           OCCURS  31.
      *    外泊
       01  TBL-GAIHAKU-AREA.
           03  TBL-GAIHAKU-OCC         OCCURS   31.
               05  TBL-GAI-DAY         PIC 9(01).
      *    入院期間
       01  TBL-NYUIN-AREA.
           03  TBL-NYUIN-OCC         OCCURS   31.
               05  TBL-NYU-DAY         PIC 9(01).
               05  TBL-NYU-SRYKA       PIC X(02).
               05  TBL-NYU-HKNCOMBI    PIC X(04).
      *
      *
      *****************************************************************
      *    ファイルレイアウト
      *****************************************************************
      *
      *    患者マスタ−
       01  PTINF-REC.
           COPY    "CPPTINF.INC".
      *
      *    診療行為マスター
       01  SRYACT-REC.
           COPY    "CPSRYACT.INC".
      *
      *    診療会計マスタ−
       01  SRYACCT-REC.
           COPY    "CPSRYACCT.INC".
      *
      *    保険組み合わせ
       01  HKNCOMBI-REC.
           COPY    "CPHKNCOMBI.INC".
      *
      *    受診履歴
       01  JYURRK-REC.
           COPY    "CPJYURRK.INC".
      *
      *    入院診療会計マスタ−
       01  NYUINACCT-REC.
           COPY    "CPNYUINACCT.INC".
      *
      *    患者入院履歴
       01  PTNYUINRRK-REC.
           COPY    "CPPTNYUINRRK.INC".
      *
      *    点数マスタ−
      *01  TENSU-REC.
           COPY    "CPTENSU.INC".
      *
      *****************************************************************
      *    サブプロ用　領域
      *****************************************************************
      *
      *   日付変換サブ
           COPY    "CPORCSDAY.INC".
           COPY    "CPORCSLNK.INC".
      *
      *   算定履歴更新サブ
           COPY    "CPORCSSANTEI.INC".
      *
      *    ＤＢ検索
           COPY    "MCPDATA.INC".
           COPY    "CPORCMCP.INC".
      *
           COPY    "MCPAREA".
           COPY    "ORCA-SPA".
      *
      *
      *****************************************************************
      *    連絡　領域
      *****************************************************************
        LINKAGE                     SECTION.
      *
      *    スパ領域
           COPY    "COMMON-SPA".
      *    診療行為入院更新パラメタ領域
           COPY    "CPORCSCHOZAI.INC".
      *
       PROCEDURE                   DIVISION    USING
           SPA-AREA
           ORCSCHOZAIAREA
           .
      *
      *****************************************************************
      *    主　　処理
      *****************************************************************
       000-PROC-SEC                SECTION.
      *
           INITIALIZE                  FLG-AREA
           INITIALIZE                  IDX-AREA
           INITIALIZE                  WRK-AREA
           INITIALIZE                  TBL-TOUYAKU-AREA
           INITIALIZE                  TBL-CHOZAI-AREA
           INITIALIZE                  TBL-MADOKU-AREA
           INITIALIZE                  TBL-GAIHAKU-AREA
      *
           INITIALIZE                  ORCSCHO-ERRCD
      *
           MOVE    "1"                 TO  SPA-NYUGAIKBN
      *
      *    入院・外泊の編集
           PERFORM 200-GAIHAKU-HEN-SEC
      *
      *    投薬の日数編集
           PERFORM 100-TOUYAKU-HEN-SEC
      *
      *    入院調剤料と麻毒の確定
           PERFORM 300-CHOZAI-HEN-SEC
      *
      *    入院調剤料と麻毒の更新
           PERFORM 400-SANTEI-SYORI-SEC
      *
           .
       000-PROC-EXT.
      *
           EXIT    PROGRAM
           .
      *****************************************************************
      *    投薬の日数編集処理
      *****************************************************************
       100-TOUYAKU-HEN-SEC             SECTION.
      *
           INITIALIZE                  TBL-TOUYAKU-AREA
           MOVE    ORCSCHO-SRYYM       TO  WRK-SRYYM
      *    前１月分
           COMPUTE WRK-SRYMM           =   WRK-SRYMM   -   1
           IF      WRK-SRYMM           =   ZERO
               COMPUTE WRK-SRYYY       =   WRK-SRYYY   -   1
               MOVE    12              TO  WRK-SRYMM
           END-IF
           PERFORM VARYING     IDX     FROM    1   BY  1
                   UNTIL       IDX     >   2
      *        診療年月の末日算定
               INITIALIZE                      STS-AREA-DAY
               INITIALIZE                      LNK-DAY7-AREA
               MOVE    "71"                TO  LNK-DAY7-IRAI
               MOVE    WRK-SRYYM           TO  LNK-DAY7-YM
               CALL    "ORCSDAY"           USING
                                           STS-AREA-DAY
                                           LNK-DAY7-AREA
               MOVE    LNK-DAY7-KOYOMI(7:2)    TO  WRK-MATU
      *
               MOVE    "21"                TO  WRK-SRYKBN
               PERFORM 10011-SRYACCT-21HEN-SEC
      *        次月
               COMPUTE WRK-SRYMM           =   WRK-SRYMM   +   1
               IF      WRK-SRYMM           >   12
                   COMPUTE WRK-SRYYY       =   WRK-SRYYY   +   1
                   MOVE    1               TO  WRK-SRYMM
               END-IF
      *
           END-PERFORM
      *    頓服
           MOVE    "22"                TO  WRK-SRYKBN
           MOVE    ORCSCHO-SRYYM       TO  WRK-SRYYM
           PERFORM 10012-SRYACCT-HEN-SEC
      *    外用
           MOVE    "23"                TO  WRK-SRYKBN
           MOVE    ORCSCHO-SRYYM       TO  WRK-SRYYM
           PERFORM 10012-SRYACCT-HEN-SEC
      *
           .
       100-TOUYAKU-HEN-EXT.
           EXIT.
      *****************************************************************
      *    投薬の編集処理
      *****************************************************************
       10011-SRYACCT-21HEN-SEC             SECTION.
      *
      *    診療年月の診療会計マスタ読み込み
           MOVE    SPACE               TO  SRYACCT-REC
           INITIALIZE                      SRYACCT-REC
           MOVE    SPA-HOSPID          TO  ACCT-HOSPID
           MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
           MOVE    ORCSCHO-PTID        TO  ACCT-PTID
           MOVE    WRK-SRYYM           TO  ACCT-SRYYM
           MOVE    "21"                TO  ACCT-SRYKBN
      *
           MOVE    SRYACCT-REC         TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           ELSE
               MOVE    1                   TO  FLG-SRYACCT
           END-IF
           PERFORM
               UNTIL       (FLG-SRYACCT         =   1       )
             IF      ACCT-YKZTEN       >   ZERO
      *        最初の日を保存（点数マスタ検索のため）
               MOVE    01                  TO  WRK-DD
               PERFORM VARYING     IDY2    FROM    1   BY  1
                       UNTIL       IDY2    >   31
                   IF      ACCT-DAY (1 IDY2)   >   ZERO
                       MOVE    IDY2                TO  WRK-DD
                   END-IF
               END-PERFORM
      *        診療行為より麻毒判定
               PERFORM 600111-SRYACT-HEN-SEC
      *        回数により保存
               PERFORM VARYING     IDY2    FROM    1   BY  1
                       UNTIL       IDY2    >   31
      *            投薬の日が入院中であること
                   IF      ACCT-DAY (1 IDY2)   >   ZERO
                       MOVE    ACCT-DAY (1 IDY2)   TO  WRK-KAISU
                       PERFORM VARYING IDX2    FROM    1   BY   1
                               UNTIL   IDX2    >   WRK-KAISU
                           COMPUTE IDX3        =   IDY2
                                               +   IDX2
                                               -   1
                           IF      IDX3        >   WRK-MATU
      *                        翌月へ
                               COMPUTE IDX3        =   IDX3
                                                   -   WRK-MATU
      *                        ２月以上またがらないこととする
                               IF      IDX3        >   31
                                   MOVE    31          TO  IDX3
                               END-IF
                               COMPUTE IDX1            =   IDX   +   1
                           ELSE
                               MOVE    IDX             TO  IDX1
                           END-IF
      *                    当月で退院以降はなしとする
                           IF     (IDX1            =   2  )  AND
                                  (TBL-NYU-DAY (IDX3)  =   ZERO)
                               MOVE    WRK-KAISU       TO  IDX2
                           ELSE
                               MOVE    1               TO  TBL-TOU-DAY
                                                            (IDX1 IDX3)
                               PERFORM 100111-TOU-SRYKAHEN-SEC
                               IF      FLG-MADOKU      =   1
                                   MOVE    1           TO  TBL-DOK-DAY
                                                            (IDX1 IDX3)
                                   PERFORM 100112-DOK-SRYKAHEN-SEC
                               END-IF
                           END-IF
                       END-PERFORM
                   END-IF
               END-PERFORM
      *
             END-IF
      *
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           END-PERFORM
      *
      *    MOVE    "DBCLOSE"           TO  MCP-FUNC
      *    MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
      *    CALL    "ORCMCPSUB"         USING
      *                                MCPAREA
      *                                MCPDATA-REC
      *
      *
           .
       10011-SRYACCT-21HEN-EXT.
           EXIT.
      *****************************************************************
      *    診療科・保険編集処理（投薬）
      *****************************************************************
       100111-TOU-SRYKAHEN-SEC             SECTION.
      *
           PERFORM VARYING     IDX-T    FROM    1   BY  1
                   UNTIL       IDX-T    >   10
               IF      TBL-TOU-SRYKA (IDX1 IDX3 IDX-T) =   SPACE
                   MOVE    ACCT-SRYKA      TO  TBL-TOU-SRYKA
                                                       (IDX1 IDX3 IDX-T)
                   MOVE    ACCT-HKNCOMBI   TO  TBL-TOU-HKNCOMBI
                                                       (IDX1 IDX3 IDX-T)
               END-IF
               IF     (TBL-TOU-SRYKA (IDX1 IDX3 IDX-T)
                                               =   ACCT-SRYKA  )   AND 
                      (TBL-TOU-HKNCOMBI(IDX1 IDX3 IDX-T)
                                               =   ACCT-HKNCOMBI)
                   MOVE    10              TO  IDX-T
               END-IF
           END-PERFORM
      *
           .
       100111-TOU-SRYKAHEN-EXT.
           EXIT.
      *****************************************************************
      *    診療科・保険編集処理（麻毒）
      *****************************************************************
       100112-DOK-SRYKAHEN-SEC             SECTION.
      *
           PERFORM VARYING     IDX-T    FROM    1   BY  1
                   UNTIL       IDX-T    >   10
               IF      TBL-DOK-SRYKA (IDX1 IDX3 IDX-T) =   SPACE
                   MOVE    ACCT-SRYKA      TO  TBL-DOK-SRYKA
                                                       (IDX1 IDX3 IDX-T)
                   MOVE    ACCT-HKNCOMBI   TO  TBL-DOK-HKNCOMBI
                                                       (IDX1 IDX3 IDX-T)
               END-IF
               IF     (TBL-DOK-SRYKA (IDX1 IDX3 IDX-T)
                                               =   ACCT-SRYKA  )   AND 
                      (TBL-DOK-HKNCOMBI(IDX1 IDX3 IDX-T)
                                               =   ACCT-HKNCOMBI)
                   MOVE    10              TO  IDX-T
               END-IF
           END-PERFORM
      *
           .
       100112-DOK-SRYKAHEN-EXT.
           EXIT.
      *****************************************************************
      *    頓服・外用の編集処理
      *****************************************************************
       10012-SRYACCT-HEN-SEC             SECTION.
      *
      *    診療年月の診療会計マスタ読み込み
           MOVE    SPACE               TO  SRYACCT-REC
           INITIALIZE                      SRYACCT-REC
           MOVE    SPA-HOSPID          TO  ACCT-HOSPID
           MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
           MOVE    ORCSCHO-PTID        TO  ACCT-PTID
           MOVE    WRK-SRYYM           TO  ACCT-SRYYM
           MOVE    WRK-SRYKBN          TO  ACCT-SRYKBN
      *
           MOVE    SRYACCT-REC         TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           ELSE
               MOVE    1                   TO  FLG-SRYACCT
           END-IF
           PERFORM
               UNTIL       (FLG-SRYACCT         =   1       )
               IF      ACCT-YKZTEN       >   ZERO
      *            最初の日を保存（点数マスタ検索のため）
                   MOVE    01                  TO  WRK-DD
                   PERFORM VARYING     IDY2    FROM    1   BY  1
                           UNTIL       IDY2    >   31
                       IF      ACCT-DAY (1 IDY2)   >   ZERO
                           MOVE    IDY2                TO  WRK-DD
                       END-IF
                   END-PERFORM
      *            診療行為より麻毒判定
                   PERFORM 600111-SRYACT-HEN-SEC
      *            回数により保存
                   PERFORM VARYING     IDX3    FROM    1   BY  1
                           UNTIL       IDX3    >   31
                       IF      ACCT-DAY (1 IDX3)   >   ZERO
                           MOVE    1               TO  TBL-TOU-DAY
                                                            (2  IDX3)
                           MOVE    2               TO  IDX1
                           PERFORM 100111-TOU-SRYKAHEN-SEC
                           IF      FLG-MADOKU      =   1
                               MOVE    1               TO  TBL-DOK-DAY
                                                            (2  IDX3)
                               PERFORM 100112-DOK-SRYKAHEN-SEC
                           END-IF
                       END-IF
                   END-PERFORM
               END-IF
      *
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           END-PERFORM
      *
      *    MOVE    "DBCLOSE"           TO  MCP-FUNC
      *    MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
      *    CALL    "ORCMCPSUB"         USING
      *                                MCPAREA
      *                                MCPDATA-REC
      *
      *
           .
       10012-SRYACCT-HEN-EXT.
           EXIT.
      *****************************************************************
      *    診療行為マスター編集処理
      *****************************************************************
       600111-SRYACT-HEN-SEC             SECTION.
      *
           MOVE    ZERO                TO  FLG-ARI
           MOVE    ZERO                TO  FLG-MADOKU
      *    診療会計マスターから診療行為マスターを検索する
           MOVE    SPACE               TO  SRYACT-REC
           INITIALIZE                      SRYACT-REC
           MOVE    ACCT-HOSPID         TO  SRY-HOSPID
           MOVE    ACCT-NYUGAIKBN      TO  SRY-NYUGAIKBN
           MOVE    ACCT-PTID           TO  SRY-PTID
           MOVE    ACCT-SRYKA          TO  SRY-SRYKA
           MOVE    ACCT-SRYYM          TO  SRY-SRYYM
           MOVE    ACCT-ZAINUM         TO  SRY-ZAINUM
      *
           MOVE    SRYACT-REC          TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "SRYACT-KEY2"       TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       ORCMCPAREA
                                       MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "SRYACT-KEY2"       TO  ORC-DBPATH
               PERFORM 920-SRYACT-NEXT-SEC
           ELSE
               MOVE    1                   TO  FLG-SRYACT
           END-IF
           PERFORM UNTIL      FLG-SRYACT   =   1
               PERFORM VARYING     IDX2    FROM    1   BY  1
                       UNTIL      (IDX2            >   5   )  OR
                                  (FLG-MADOKU      =   1    )  OR
                                  (SRY-SRYCD(IDX2) =   SPACE )
      *            薬剤
                   IF      SRY-SRYCD (IDX2)(1:1)   =   "6"
                       MOVE    1                   TO  FLG-ARI
      *                点数マスタ
                       MOVE    SRY-SRYCD (IDX2)    TO  TNS-SRYCD
                       PERFORM 910-TENSU-READ-SEC
                       IF      TNS-MADOKUKBN       NOT =   ZERO
                           MOVE    1               TO  FLG-MADOKU
                       END-IF
                   END-IF
               END-PERFORM
      *
               MOVE    "SRYACT-KEY2"       TO  ORC-DBPATH
               PERFORM 920-SRYACT-NEXT-SEC
           END-PERFORM
      *
      *    MOVE    "DBCLOSE"           TO  MCP-FUNC
      *    MOVE    "SRYACT-KEY2"       TO  ORC-DBPATH
      *    CALL    "ORCMCPSUB"         USING
      *                                MCPAREA
      *                                MCPDATA-REC
      *                                MCPDATA-REC
      *
      *
           .
       600111-SRYACT-HEN-EXT.
           EXIT.
      *****************************************************************
      *    入院・外泊の編集処理
      *****************************************************************
       200-GAIHAKU-HEN-SEC             SECTION.
      *
      *    診療会計マスターを特定する
           INITIALIZE                      NYUINACCT-REC
           MOVE    SPA-HOSPID          TO  NACCT-HOSPID
           MOVE    SPA-NYUGAIKBN       TO  NACCT-NYUGAIKBN
           MOVE    ORCSCHO-PTID        TO  NACCT-PTID
           MOVE    ORCSCHO-SRYYM       TO  NACCT-SRYYM
           MOVE    "2"                 TO  NACCT-ZAISKBKBN
      *
           MOVE    NYUINACCT-REC       TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "NYUINACCT-KEY17"   TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       ORCMCPAREA
                                       MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "NYUINACCT-KEY17"    TO  ORC-DBPATH
               PERFORM 930-NYUINACCT-READ-SEC
           ELSE
               MOVE    1                   TO  FLG-NYUINACCT
           END-IF
           PERFORM
               UNTIL   FLG-NYUINACCT       =   1
               PERFORM VARYING     IDX     FROM    1   BY  1
                       UNTIL       IDX     >   31
                   IF      NACCT-DAY (IDX) >   ZERO
                       MOVE    NACCT-DAY (IDX)     TO  TBL-GAI-DAY(IDX)
                   END-IF
               END-PERFORM
      *
               MOVE    "NYUINACCT-KEY17"    TO  ORC-DBPATH
               PERFORM 930-NYUINACCT-READ-SEC
           END-PERFORM
      *
      *
      *    入院履歴判定
           MOVE    SPACE               TO  PTNYUINRRK-REC
           INITIALIZE                  PTNYUINRRK-REC
           MOVE    SPA-HOSPID          TO  PTNYUINRRK-HOSPID
           MOVE    ORCSCHO-PTID        TO  PTNYUINRRK-PTID
      *
           MOVE    PTNYUINRRK-REC      TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "PTNYUINRRK-KEY2"  TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       ORCMCPAREA
                                       MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "PTNYUINRRK-KEY2"  TO  ORC-DBPATH
               PERFORM 910-PTNYUINRRK-READ-SEC
           ELSE
               MOVE    1               TO  FLG-PTNYUINRRK
               INITIALIZE                  PTNYUINRRK-REC
           END-IF
           INITIALIZE                  TBL-NYUIN-AREA
           MOVE    ZERO                TO  FLG-OK
           PERFORM
                   UNTIL      (FLG-PTNYUINRRK      =   1 )  OR
                              (FLG-OK              =   1 )  OR
                              (PTNYUINRRK-TAIINYMD(1:6)
                                                   <  ORCSCHO-SRYYM)
      *        入院日から９０日以上の判定
               MOVE    ZERO                    TO  WRK-MAX
               IF      PTNYUINRRK-NYUINYMD(1:6)    <   ORCSCHO-SRYYM
                   INITIALIZE                      STS-AREA-DAY
                   INITIALIZE                      LNK-DAY6-AREA
                   MOVE    "61"                TO  LNK-DAY6-IRAI
                   MOVE    PTNYUINRRK-NYUINYMD TO  LNK-DAY6-KIJUN
                   MOVE    "1"                 TO  LNK-DAY6-ZOGENPTN
                   MOVE    90                  TO  LNK-DAY6-ZOGEN
                   CALL    "ORCSDAY"           USING   STS-AREA-DAY
                                                       LNK-DAY6-AREA
                   IF      LNK-DAY6-KOYOMI(1:6)    =   ORCSCHO-SRYYM
                       MOVE    LNK-DAY6-KOYOMI(7:2)    TO  WRK-MAX
                   END-IF
                   IF      LNK-DAY6-KOYOMI(1:6)    <   ORCSCHO-SRYYM
                       MOVE    31                      TO  WRK-MAX
                   END-IF
               END-IF
      *
      *        入院中の時
               MOVE    ZERO                TO  IDX-S
               MOVE    ZERO                TO  IDX-E
               IF     (PTNYUINRRK-NYUINYMD(1:6)  <   ORCSCHO-SRYYM) AND
                      (PTNYUINRRK-TAIINYMD(1:6)  >   ORCSCHO-SRYYM)
                   MOVE    1               TO  IDX-S
                   MOVE    31              TO  IDX-E
                   MOVE    1               TO  FLG-OK
               END-IF
      *        入院日
               IF      PTNYUINRRK-NYUINYMD(1:6)  =   ORCSCHO-SRYYM
                   MOVE    PTNYUINRRK-NYUINYMD(7:2)  TO  IDX-S
               END-IF
               IF      PTNYUINRRK-NYUINYMD(1:6)  <   ORCSCHO-SRYYM
                   MOVE    1                         TO  IDX-S
               END-IF
      *        退院日
               IF     PTNYUINRRK-TAIINYMD(1:6)   =   ORCSCHO-SRYYM
                   MOVE    PTNYUINRRK-TAIINYMD(7:2)  TO  IDX-E
               END-IF
               IF    (PTNYUINRRK-TAIINYMD(1:6)   >   ORCSCHO-SRYYM) OR
                     (PTNYUINRRK-TAIINYMD        =   ALL "9"  )
                   MOVE    31                        TO  IDX-E
               END-IF
      *
               IF     (IDX-S               >   ZERO )  AND
                      (IDX-E               >   ZERO )
                   PERFORM VARYING     IDX     FROM    IDX-S  BY  1
                           UNTIL       IDX     >   IDX-E
                       MOVE    1                   TO  TBL-NYU-DAY(IDX)
      *                入院の科と保険
                       MOVE    PTNYUINRRK-NYUINKA  TO  TBL-NYU-SRYKA
                                                                  (IDX)
                       MOVE    PTNYUINRRK-HKNCOMBINUM
                                                   TO  TBL-NYU-HKNCOMBI
                                                                  (IDX)
                   END-PERFORM
               END-IF
      *
               IF      WRK-MAX             >   ZERO
                   ADD     1               TO  WRK-MAX
                   PERFORM VARYING     IDX     FROM    WRK-MAX BY  1
                           UNTIL       IDX     >   31
                       MOVE    ZERO                TO  TBL-NYU-DAY(IDX)
                   END-PERFORM
               END-IF
      *
               MOVE    "PTNYUINRRK-KEY2"   TO  ORC-DBPATH
               PERFORM 910-PTNYUINRRK-READ-SEC
           END-PERFORM
      *
           .
       200-GAIHAKU-HEN-EXT.
           EXIT.
      *****************************************************************
      *    入院調剤料と麻毒の確定処理
      *****************************************************************
       300-CHOZAI-HEN-SEC             SECTION.
      *
      *    調剤料
           MOVE    ZERO                TO  IDX1
           INITIALIZE                  TBL-CHOZAI-AREA
      *
      *    診療年月の診療会計マスタ読み込み
           MOVE    SPACE               TO  SRYACCT-REC
           INITIALIZE                      SRYACCT-REC
           MOVE    SPA-HOSPID          TO  ACCT-HOSPID
           MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
           MOVE    ORCSCHO-PTID        TO  ACCT-PTID
           MOVE    ORCSCHO-SRYYM       TO  ACCT-SRYYM
           MOVE    "24"                TO  ACCT-SRYKBN
      *
           MOVE    SRYACCT-REC         TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           ELSE
               MOVE    1                   TO  FLG-SRYACCT
           END-IF
           PERFORM
               UNTIL       (FLG-SRYACCT         =   1 )  OR
                           (IDX1                >=  10 )
               IF      ACCT-SYUTEN1        >   ZERO
                   ADD     1                   TO  IDX1
                   MOVE    ACCT-ZAINUM         TO  TBL-CHO-ZAINUM(IDX1)
                   MOVE    ACCT-SRYKA          TO  TBL-CHO-SRYKA (IDX1)
                   MOVE    ACCT-HKNCOMBI       TO  TBL-CHO-HKNCOMBI
                                                                 (IDX1)
                   MOVE    ACCT-DAY-AREA       TO  TBL-CHO-DAY-AREA
                                                                 (IDX1)
               END-IF
      *
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           END-PERFORM
      *
           MOVE    "DBCLOSE"           TO  MCP-FUNC
           MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       MCPDATA-REC
      *
      *    麻毒料
           MOVE    ZERO                TO  IDX1
           INITIALIZE                  TBL-MADOKU-AREA
      *
      *    診療年月の診療会計マスタ読み込み
           MOVE    SPACE               TO  SRYACCT-REC
           INITIALIZE                      SRYACCT-REC
           MOVE    SPA-HOSPID          TO  ACCT-HOSPID
           MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
           MOVE    ORCSCHO-PTID        TO  ACCT-PTID
           MOVE    ORCSCHO-SRYYM       TO  ACCT-SRYYM
           MOVE    "26"                TO  ACCT-SRYKBN
      *
           MOVE    SRYACCT-REC         TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           ELSE
               MOVE    1                   TO  FLG-SRYACCT
           END-IF
           PERFORM
               UNTIL       (FLG-SRYACCT         =   1 )  OR
                           (IDX1                >=  10 )
               ADD     1                   TO  IDX1
               MOVE    ACCT-ZAINUM         TO  TBL-MAD-ZAINUM  (IDX1)
               MOVE    ACCT-SRYKA          TO  TBL-MAD-SRYKA   (IDX1)
               MOVE    ACCT-HKNCOMBI       TO  TBL-MAD-HKNCOMBI(IDX1)
               MOVE    ACCT-DAY-AREA       TO  TBL-MAD-DAY-AREA(IDX1)
      *
               MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
               PERFORM 930-SRYACCT-READ-SEC
           END-PERFORM
      *
           MOVE    "DBCLOSE"           TO  MCP-FUNC
           MOVE    "SRYACCT-KEY14"     TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       MCPDATA-REC
      *
           .
       300-CHOZAI-HEN-EXT.
           EXIT.
      *
      *****************************************************************
      *    調剤料再編集処理
      *****************************************************************
       400-SANTEI-SYORI-SEC            SECTION.
      *
           PERFORM VARYING     IDX     FROM    1   BY  1
                   UNTIL       IDX     >   31
               IF     (TBL-TOU-DAY (2 IDX)     =   ZERO )  OR
                      (TBL-GAI-DAY (IDX)       >   ZERO )  OR
                      (TBL-NYU-DAY (IDX)       =   ZERO )
      *            調剤料なし
                   PERFORM 4001-TOU-DEL-SYORI-SEC
               ELSE
      *            調剤料あり
                   PERFORM 4002-TOU-ADD-SYORI-SEC
               END-IF
      *
               IF     (TBL-DOK-DAY (2 IDX)     =   ZERO )  OR
                      (TBL-GAI-DAY (IDX)       >   ZERO )  OR
                      (TBL-NYU-DAY (IDX)       =   ZERO )
      *            調剤料なし
                   PERFORM 4003-MAD-DEL-SYORI-SEC
               ELSE
      *            調剤料あり
                   PERFORM 4004-MAD-ADD-SYORI-SEC
               END-IF
           END-PERFORM
      *
      *    調剤料更新
           PERFORM 4005-CHOU-UPDATE-SEC
      *
      *    麻毒更新
           PERFORM 4006-MADO-UPDATE-SEC
           .
      *
       400-SANTEI-SYORI-EXT.
           EXIT.
      *
      *****************************************************************
      *    調剤料なし処理
      *****************************************************************
       4001-TOU-DEL-SYORI-SEC            SECTION.
      *
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL      (IDX2    >   10  )  OR
                              (TBL-CHO-ZAINUM(IDX2)    =   ZERO )
               MOVE    ZERO           TO  TBL-CHO-DAY (IDX2 1 IDX)
               MOVE    ZERO           TO  TBL-CHO-DAY (IDX2 2 IDX)
               MOVE    ZERO           TO  TBL-CHO-DAY (IDX2 3 IDX)
               MOVE    ZERO           TO  TBL-CHO-DAY (IDX2 4 IDX)
           END-PERFORM
           .
      *
       4001-TOU-DEL-SYORI-EXT.
           EXIT.
      *
      *****************************************************************
      *    調剤料あり処理
      *****************************************************************
       4002-TOU-ADD-SYORI-SEC            SECTION.
      *
           MOVE    ZERO                TO  FLG-ARI
           MOVE    ZERO                TO  WRK-IDX2
      *
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL      (IDX2    >   10  )  OR
                              (TBL-CHO-ZAINUM(IDX2)    =   ZERO )
               MOVE    ZERO            TO  FLG-CHK
               PERFORM VARYING     IDX-T   FROM    1   BY  1
                       UNTIL      (IDX-T   >   10  )  OR
                              (TBL-TOU-SRYKA(2 IDX IDX-T)  =  SPACE)
      *            当日入力の科・保険であること
                   IF     (TBL-CHO-SRYKA(IDX2)     =   TBL-TOU-SRYKA
                                                     (2 IDX IDX-T)) AND
                          (TBL-CHO-HKNCOMBI(IDX2)  =   TBL-TOU-HKNCOMBI
                                                     (2 IDX IDX-T))
                       MOVE    1               TO  FLG-CHK
                   END-IF
               END-PERFORM
               IF      FLG-CHK         =   1
                   MOVE    IDX2            TO  WRK-IDX2
                   IF      TBL-CHO-DAY (IDX2 1 IDX)   >   ZERO
                       IF      FLG-ARI         =   ZERO
                           MOVE    1               TO  FLG-ARI
                       ELSE
                           MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 1 IDX)
                           MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 2 IDX)
                           MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 3 IDX)
                           MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 4 IDX)
                       END-IF
                   END-IF
               ELSE
                   MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 1 IDX)
                   MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 2 IDX)
                   MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 3 IDX)
                   MOVE    ZERO            TO  TBL-CHO-DAY
                                                         (IDX2 4 IDX)
               END-IF
           END-PERFORM
           IF     FLG-ARI              =   1
               GO      TO      4002-TOU-ADD-SYORI-EXT
           END-IF
      *    当日調剤料指定がない時、対象の剤へ
           IF      WRK-IDX2            >   ZERO
               MOVE    1               TO  TBL-CHO-DAY (WRK-IDX2 1 IDX)
               MOVE    1               TO  TBL-CHO-DAY (WRK-IDX2 2 IDX)
               GO      TO      4002-TOU-ADD-SYORI-EXT
           END-IF
      *
      *    当日調剤料指定がない時、作成へ
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL      (IDX2    >   10  )
               IF      TBL-CHO-ZAINUM(IDX2)    =   ZERO
                   MOVE    "1"                 TO  TBL-CHO-ADD (IDX2)
      *            当日入力の科・保険で作成する
                   MOVE    TBL-TOU-SRYKA   (2 IDX 1)
                                           TO  TBL-CHO-SRYKA(IDX2)
                   MOVE    TBL-TOU-HKNCOMBI(2 IDX 1)
                                           TO  TBL-CHO-HKNCOMBI (IDX2)
                   MOVE    1               TO  TBL-CHO-DAY (IDX2 1 IDX)
                   MOVE    1               TO  TBL-CHO-DAY (IDX2 2 IDX)
                   MOVE    10              TO  IDX2
               END-IF
           END-PERFORM
           .
      *
       4002-TOU-ADD-SYORI-EXT.
           EXIT.
      *
      *****************************************************************
      *    麻毒なし処理
      *****************************************************************
       4003-MAD-DEL-SYORI-SEC            SECTION.
      *
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL      (IDX2    >   10  )  OR
                              (TBL-MAD-ZAINUM(IDX2)    =   ZERO )
               MOVE    ZERO           TO  TBL-MAD-DAY (IDX2 1 IDX)
               MOVE    ZERO           TO  TBL-MAD-DAY (IDX2 2 IDX)
               MOVE    ZERO           TO  TBL-MAD-DAY (IDX2 3 IDX)
               MOVE    ZERO           TO  TBL-MAD-DAY (IDX2 4 IDX)
           END-PERFORM
           .
      *
       4003-MAD-DEL-SYORI-EXT.
           EXIT.
      *
      *****************************************************************
      *    麻毒あり処理
      *****************************************************************
       4004-MAD-ADD-SYORI-SEC            SECTION.
      *
           MOVE    ZERO                TO  FLG-ARI
           MOVE    ZERO                TO  WRK-IDX2
      *
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL      (IDX2    >   10  )  OR
                              (TBL-MAD-ZAINUM(IDX2)    =   ZERO )
               MOVE    ZERO            TO  FLG-CHK
               PERFORM VARYING     IDX-T   FROM    1   BY  1
                       UNTIL      (IDX-T   >   10  )  OR
                              (TBL-DOK-SRYKA(2 IDX IDX-T)  =  SPACE)
      *            当日入力の科・保険であること
                   IF     (TBL-MAD-SRYKA(IDX2)     =   TBL-DOK-SRYKA
                                                     (2 IDX IDX-T)) AND
                          (TBL-MAD-HKNCOMBI(IDX2)  =   TBL-DOK-HKNCOMBI
                                                     (2 IDX IDX-T))
                       MOVE    1               TO  FLG-CHK
                   END-IF
               END-PERFORM
               IF      FLG-CHK         =   1
                   MOVE    IDX2            TO  WRK-IDX2
                   IF      TBL-MAD-DAY (IDX2 1 IDX)   >   ZERO
                       IF      FLG-ARI         =   ZERO
                           MOVE    1               TO  FLG-ARI
                       ELSE
                           MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 1 IDX)
                           MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 2 IDX)
                           MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 3 IDX)
                           MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 4 IDX)
                       END-IF
                   END-IF
               ELSE
                   MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 1 IDX)
                   MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 2 IDX)
                   MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 3 IDX)
                   MOVE    ZERO            TO  TBL-MAD-DAY
                                                         (IDX2 4 IDX)
               END-IF
           END-PERFORM
           IF     FLG-ARI              =   1
               GO      TO      4004-MAD-ADD-SYORI-EXT
           END-IF
      *    当日調剤料指定がない時、対象の剤へ
           IF      WRK-IDX2            >   ZERO
               MOVE    1               TO  TBL-MAD-DAY (WRK-IDX2 1 IDX)
               MOVE    1               TO  TBL-MAD-DAY (WRK-IDX2 2 IDX)
               GO      TO      4004-MAD-ADD-SYORI-EXT
           END-IF
      *
      *    当日調剤料指定がない時、作成へ
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL      (IDX2    >   10  )
               IF      TBL-MAD-ZAINUM(IDX2)    =   ZERO
                   MOVE    "1"                 TO  TBL-MAD-ADD (IDX2)
      *            当日入力の科・保険で作成する
                   MOVE    TBL-DOK-SRYKA(2 IDX 1)
                                           TO  TBL-MAD-SRYKA(IDX2)
                   MOVE    TBL-DOK-HKNCOMBI(2 IDX 1)
                                           TO  TBL-MAD-HKNCOMBI (IDX2)
                   MOVE    1               TO  TBL-MAD-DAY (IDX2 1 IDX)
                   MOVE    1               TO  TBL-MAD-DAY (IDX2 2 IDX)
                   MOVE    10              TO  IDX2
               END-IF
           END-PERFORM
      *
           .
      *
       4004-MAD-ADD-SYORI-EXT.
           EXIT.
      *
      *****************************************************************
      *    調剤料更新処理
      *****************************************************************
       4005-CHOU-UPDATE-SEC            SECTION.
      *
           PERFORM VARYING     IDX     FROM    1   BY  1
                   UNTIL      (IDX     >   10  )  OR
                              (TBL-CHO-ZAINUM(IDX) =   ZERO )
               INITIALIZE                      SRYACCT-REC
               MOVE    SPA-HOSPID          TO  ACCT-HOSPID
               MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
               MOVE    ORCSCHO-PTID        TO  ACCT-PTID
               MOVE    TBL-CHO-SRYKA (IDX) TO  ACCT-SRYKA
               MOVE    ORCSCHO-SRYYM       TO  ACCT-SRYYM
               MOVE    "24"                TO  ACCT-SRYKBN
               MOVE    TBL-CHO-ZAINUM(IDX) TO  ACCT-ZAINUM
      *
               MOVE    SRYACCT-REC         TO  MCPDATA-REC
               MOVE    "DBSELECT"          TO  MCP-FUNC
               MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
               CALL    "ORCMCPSUB"          USING
                                            MCPAREA
                                            ORCMCPAREA
                                            MCPDATA-REC
               IF      MCP-RC              =   ZERO
                   MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
                   PERFORM 930-SRYACCT-READ-SEC
               ELSE
                   INITIALIZE                  SRYACCT-REC
                   MOVE    1               TO  FLG-SRYACCT
               END-IF
               IF      FLG-SRYACCT          =   ZERO
      *            診療会計マスターを変更する
                   MOVE    TBL-CHO-DAY-AREA(IDX)   TO  ACCT-DAY-AREA
                   PERFORM 40051-DAY-UPD-SEC
      *
      *            退院で回数がない時、削除する
                   IF     (ORCSCHO-KBN         =   "2"  )  AND
                          (ACCT-ZAIKAISU       =   ZERO )
                       PERFORM 40052-SRYACCT-DEL-SEC
                   ELSE
      *
                   MOVE    SRYACCT-REC         TO  MCPDATA-REC
                   MOVE    "DBUPDATE"          TO  MCP-FUNC
                   MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
                   CALL    "ORCMCPSUB"          USING
                                                MCPAREA
                                                ORCMCPAREA
                                                MCPDATA-REC
                   IF      MCP-RC          NOT =   ZERO
                        DISPLAY "ORCSCHOZAI SRYACCT UPD ERR:" MCP-RC
                                ",KEY:" ACCT-KEY
                        MOVE    1               TO  ORCSCHO-ERRCD
                        GO  TO  4005-CHOU-UPDATE-EXT
                   END-IF
      *
                   END-IF
               ELSE
                   DISPLAY "ORCSCHOZAII SRYACCT READ ERR:" ACCT-KEY
               END-IF
      *
               MOVE    "DBCLOSE"           TO  MCP-FUNC
               MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
               CALL    "ORCMCPSUB"          USING
                                            MCPAREA
                                            ORCMCPAREA
                                            MCPDATA-REC
           END-PERFORM
      *
      *    当月入院調剤料の剤がない時、作成する
           PERFORM VARYING     IDX     FROM    1   BY  1
                   UNTIL       IDX     >   10
               IF      (TBL-CHO-ZAINUM(IDX)    =   ZERO )  AND
                       (TBL-CHO-ADD   (IDX)    =   "1"  )
                   PERFORM 40052-CHOUZAI-INS-SEC
               END-IF
           END-PERFORM
      *
           .
       4005-CHOU-UPDATE-EXT.
           EXIT.
      *
      *****************************************************************
      *    診療会計マスター削除処理
      *****************************************************************
       40052-SRYACCT-DEL-SEC           SECTION.
      *
           MOVE    SRYACCT-REC         TO  MCPDATA-REC
           MOVE    "DBDELETE"          TO  MCP-FUNC
           MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       ORCMCPAREA
                                       MCPDATA-REC
           IF      MCP-RC          NOT =   ZERO
               DISPLAY "ORCSCHOZAI SRYACCT DEL ERR:" MCP-RC
                                ",KEY:" ACCT-KEY
               MOVE    1               TO  ORCSCHO-ERRCD
           END-IF
      *
           .
       40052-SRYACCT-DEL-EXT.
           EXIT.
      *
      *****************************************************************
      *    診療会計マスター変更編集処理
      *****************************************************************
       40051-DAY-UPD-SEC           SECTION.
      *
           MOVE    ZERO                TO  ACCT-ZAIKAISU
           PERFORM VARYING     IDX-D   FROM    1   BY  1
                   UNTIL       IDX-D   >   31
              IF      ACCT-DAY (1 IDX-D)   >   ZERO
      *            剤回数　変更
                   COMPUTE ACCT-ZAIKAISU       =   ACCT-ZAIKAISU
                                               +   ACCT-DAY
                                                       (1  IDX-D)
               END-IF
           END-PERFORM
           .
       40051-DAY-UPD-EXT.
           EXIT.
      *
      *****************************************************************
      *    麻毒更新処理
      *****************************************************************
       4006-MADO-UPDATE-SEC            SECTION.
      *
           PERFORM VARYING     IDX     FROM    1   BY  1
                   UNTIL      (IDX     >   10  )  OR
                              (TBL-MAD-ZAINUM(IDX) =   ZERO )
               INITIALIZE                      SRYACCT-REC
               MOVE    SPA-HOSPID          TO  ACCT-HOSPID
               MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
               MOVE    ORCSCHO-PTID        TO  ACCT-PTID
               MOVE    TBL-MAD-SRYKA (IDX) TO  ACCT-SRYKA
               MOVE    ORCSCHO-SRYYM       TO  ACCT-SRYYM
               MOVE    "26"                TO  ACCT-SRYKBN
               MOVE    TBL-MAD-ZAINUM(IDX) TO  ACCT-ZAINUM
      *
               MOVE    SRYACCT-REC         TO  MCPDATA-REC
               MOVE    "DBSELECT"          TO  MCP-FUNC
               MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
               CALL    "ORCMCPSUB"          USING
                                            MCPAREA
                                            ORCMCPAREA
                                            MCPDATA-REC
               IF      MCP-RC              =   ZERO
                   MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
                   PERFORM 930-SRYACCT-READ-SEC
               ELSE
                   INITIALIZE                  SRYACCT-REC
                   MOVE    1               TO  FLG-SRYACCT
               END-IF
               IF      FLG-SRYACCT          =   ZERO
      *            診療会計マスターを変更する
                   MOVE    TBL-MAD-DAY-AREA(IDX)   TO  ACCT-DAY-AREA
                   PERFORM 40051-DAY-UPD-SEC
      *            退院で回数がない時、削除する
                   IF     (ORCSCHO-KBN         =   "2"  )  AND
                          (ACCT-ZAIKAISU       =   ZERO )
                       PERFORM 40052-SRYACCT-DEL-SEC
                   ELSE
      *
                   MOVE    SRYACCT-REC         TO  MCPDATA-REC
                   MOVE    "DBUPDATE"          TO  MCP-FUNC
                   MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
                   CALL    "ORCMCPSUB"          USING
                                                MCPAREA
                                                ORCMCPAREA
                                                MCPDATA-REC
                   IF      MCP-RC          NOT =   ZERO
                        DISPLAY "ORCSCHOZAI SRYACCT UPD ERR:" MCP-RC
                                ",KEY:" ACCT-KEY
                        MOVE    1               TO  ORCSCHO-ERRCD
                        GO  TO  4006-MADO-UPDATE-EXT
                   END-IF
      *
                   END-IF
               ELSE
                   DISPLAY "ORCSCHOZAI SRYACCT READ ERR:" ACCT-KEY
               END-IF
      *
      *        MOVE    "DBCLOSE"           TO  MCP-FUNC
      *        MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
      *        CALL    "ORCMCPSUB"          USING
      *                                     MCPAREA
      *                                     ORCMCPAREA
      *                                     MCPDATA-REC
           END-PERFORM
      *
      *    当月入院麻毒の剤がない時、作成する
           PERFORM VARYING     IDX     FROM    1   BY  1
                   UNTIL       IDX     >   10
               IF      (TBL-MAD-ZAINUM(IDX)    =   ZERO )  AND
                       (TBL-MAD-ADD   (IDX)    =   "1"  )
                   PERFORM 40062-MADOKU-INS-SEC
               END-IF
           END-PERFORM
      *
           .
       4006-MADO-UPDATE-EXT.
           EXIT.
      *
      *****************************************************************
      *    入院調剤料追加処理
      *****************************************************************
       40052-CHOUZAI-INS-SEC         SECTION.
      *
      *    調剤料（入院）
           MOVE    "120001110"         TO  WRK-SRYCD
           MOVE    "24"                TO  WRK-SRYKBN
           MOVE    "240"               TO  WRK-SRYSYUKBN
           MOVE    TBL-CHO-SRYKA (IDX) TO  WRK-SRYKA
           MOVE    TBL-CHO-HKNCOMBI(IDX)
                                       TO  WRK-HKNCOMBI
           MOVE    TBL-CHO-DAY-AREA(IDX)
                                       TO  WRK-DAY-AREA
      *    会計照会作成処理
           PERFORM 40052-SRYACCT-INS-SEC
           IF      ORCSCHO-ERRCD   NOT =   ZERO
               GO     TO      40052-CHOUZAI-INS-EXT
           END-IF
      *
      *    診療行為作成処理
           PERFORM 40053-SRYACT-INS-SEC
      *
           .
       40052-CHOUZAI-INS-EXT.
           EXIT.
      *
      *****************************************************************
      *    麻毒追加処理
      *****************************************************************
       40062-MADOKU-INS-SEC         SECTION.
      *
      *    麻毒料（入院）
           MOVE    "120000410"         TO  WRK-SRYCD
           MOVE    "26"                TO  WRK-SRYKBN
           MOVE    "260"               TO  WRK-SRYSYUKBN
           MOVE    TBL-MAD-SRYKA (IDX) TO  WRK-SRYKA
           MOVE    TBL-MAD-HKNCOMBI(IDX)
                                       TO  WRK-HKNCOMBI
           MOVE    TBL-MAD-DAY-AREA(IDX)
                                       TO  WRK-DAY-AREA
      *    会計照会作成処理
           PERFORM 40052-SRYACCT-INS-SEC
           IF      ORCSCHO-ERRCD   NOT =   ZERO
               GO     TO      40062-MADOKU-INS-EXT
           END-IF
      *
      *    診療行為作成処理
           PERFORM 40053-SRYACT-INS-SEC
      *
           .
       40062-MADOKU-INS-EXT.
           EXIT.
      *
      *****************************************************************
      *   会計照会作成処理
      *****************************************************************
       40052-SRYACCT-INS-SEC          SECTION.
      *
           MOVE    01                  TO  WRK-DD
           MOVE    WRK-SRYCD           TO  TNS-SRYCD
           PERFORM 910-TENSU-READ-SEC
           IF      FLG-TENSU       NOT =   ZERO
               DISPLAY "ORCSCHOZAI TENSU INV:" MCP-RC
                       ",KEY:" WRK-SRYCD
               GO      TO      40052-SRYACCT-INS-EXT
           END-IF
      *    剤番号取得処理
           PERFORM 400521-ZAINUM-SET-SEC
      *
           MOVE    SPACE               TO  SRYACCT-REC
           INITIALIZE                      SRYACCT-REC
           MOVE    SPA-HOSPID          TO  ACCT-HOSPID
           MOVE    SPA-NYUGAIKBN       TO  ACCT-NYUGAIKBN
           MOVE    ORCSCHO-PTID        TO  ACCT-PTID
           MOVE    ORCSCHO-SRYYM       TO  ACCT-SRYYM
           MOVE    WRK-SRYKBN          TO  ACCT-SRYKBN
           MOVE    WRK-SRYKA           TO  ACCT-SRYKA
           MOVE    WRK-ZAINUM          TO  ACCT-ZAINUM
           MOVE    WRK-HKNCOMBI        TO  ACCT-HKNCOMBI
      *    剤点数
           MOVE    TNS-TEN             TO  ACCT-ZAITEN
      *    診療コード計
           MOVE    WRK-SRYCD           TO  WRK-SRYCD-9
           MOVE    WRK-SRYCD-9         TO  ACCT-SRYCDTOTAL
      *    数量計
           MOVE    1                   TO  ACCT-SURYOUTOTAL
      *    明細数
           MOVE    1                   TO  ACCT-MEISAISU
      *    手技点数１
           MOVE    TNS-TEN             TO  ACCT-SYUTEN1
      *    手技点数２
           MOVE    ZERO                TO  ACCT-SYUTEN2
      *    薬剤点数
           MOVE    ZERO                TO  ACCT-YKZTEN
      *    器材点数
           MOVE    ZERO                TO  ACCT-KIZAITEN
      *    回数
           MOVE    WRK-DAY-AREA        TO  ACCT-DAY-AREA
      *    剤回数
           MOVE    ZERO                TO  ACCT-ZAIKAISU
           PERFORM VARYING     IDX2    FROM    1   BY  1
                   UNTIL       IDX2    >   31
               ADD     ACCT-DAY (1 IDX2)   TO  ACCT-ZAIKAISU
           END-PERFORM
      *
           MOVE    SRYACCT-REC         TO  MCPDATA-REC
           MOVE    "DBINSERT"          TO  MCP-FUNC
           MOVE    "SRYACCT-KEY"       TO  ORC-DBPATH
           CALL    "ORCMCPSUB"         USING
                                       MCPAREA
                                       ORCMCPAREA
                                       MCPDATA-REC
           IF      MCP-RC          NOT =   ZERO
               DISPLAY "SYRACCT INS ERR:" MCP-RC
                       ",KEY:" ACCT-KEY
               MOVE    5                   TO  ORCSCHO-ERRCD 
           END-IF
      *
           .
       40052-SRYACCT-INS-EXT.
           EXIT.
      *
      *****************************************************************
      *   剤番号取得処理
      *****************************************************************
       400521-ZAINUM-SET-SEC          SECTION.
      *
      *    患者マスターより、最終剤番号を再番し、患者マスターを更新する
           INITIALIZE                      PTINF-REC
           MOVE    SPA-HOSPID          TO  PTINF-HOSPID
           MOVE    ORCSCHO-PTID        TO  PTINF-PTID
           PERFORM 940-PTINF-READ-SEC
           IF      FLG-PTINF           =   1
               MOVE    2               TO  ORCSCHO-ERRCD 
               DISPLAY "CHOZAI ZAINUM-SET ERR:" ORCSCHO-PTID
               GO      TO      400521-ZAINUM-SET-EXT
           END-IF
      *
      *    最大剤番号
           IF      PTINF-MAXZAINUM     =   ALL "9"
               MOVE    ZERO                TO  PTINF-MAXZAINUM
           END-IF
           ADD     1                   TO  PTINF-MAXZAINUM
           MOVE    PTINF-MAXZAINUM     TO  WRK-ZAINUM
      *
           MOVE    PTINF-REC           TO  MCPDATA-REC
           MOVE    "DBUPDATE"          TO  MCP-FUNC
           MOVE    "PTINF-KEY"         TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC          NOT =   ZERO
               DISPLAY "PTINF UPDTE ERR:"   MCP-RC ",KEY:" PTINF-KEY
               MOVE    3                   TO  ORCSCHO-ERRCD 
           END-IF 
      *
           .
      *
       400521-ZAINUM-SET-EXT.
           EXIT.
      *
      *****************************************************************
      *    診療行為ＤＢ新規作成処理
      *****************************************************************
       40053-SRYACT-INS-SEC         SECTION.
      *
           INITIALIZE                          SRYACT-REC
           MOVE    ACCT-HOSPID         TO  SRY-HOSPID
           MOVE    ACCT-NYUGAIKBN      TO  SRY-NYUGAIKBN
           MOVE    ACCT-PTID           TO  SRY-PTID
           MOVE    ACCT-SRYKA          TO  SRY-SRYKA
           MOVE    ACCT-SRYYM          TO  SRY-SRYYM
      *    剤番号
           MOVE    WRK-ZAINUM          TO  SRY-ZAINUM
      *    連番号
           MOVE    1                   TO  SRY-RENNUM
           MOVE    WRK-SRYSYUKBN       TO  SRY-SRYSYUKBN
           MOVE    WRK-SRYKBN          TO  SRY-SRYKBN
           MOVE    ZERO                TO  SRY-JIHIMONEYTOTAL
      *    １明細とする
           MOVE    WRK-SRYCD           TO  SRY-SRYCD    (1)
           MOVE    1                   TO  SRY-SRYSURYO (1)
           MOVE    ZERO                TO  SRY-SRYKAISU (1)
           MOVE    "3"                 TO  SRY-AUTOKBN  (1)
           MOVE    ZERO                TO  SRY-JIHIMONEY(1)
      *
           MOVE    SRYACT-REC          TO  MCPDATA-REC
           MOVE    "DBINSERT"          TO  MCP-FUNC
           MOVE    "SRYACT-KEY"        TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
      *
           IF      MCP-RC          NOT =   ZERO
               DISPLAY "CHOZAI SRYACT INS ERR:" SRY-KEY  "."
               DISPLAY "MCP-RC:" MCP-RC ":" 
               MOVE    4               TO  ORCSCHO-ERRCD
           END-IF
      *
           .
      *
       40053-SRYACT-INS-EXT.
           EXIT.
      *
      *
      *****************************************************************
      *    点数マスター読込
      *****************************************************************
       910-TENSU-READ-SEC         SECTION.
      *
           MOVE    ZERO                TO  TNS-YUKOSTYMD
           MOVE    ALL "9"             TO  TNS-YUKOEDYMD
      *
           MOVE    TNS-TENSU-REC       TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "TENSU-KEY"         TO  ORC-DBPATH
           MOVE    ORCSCHO-SRYYM       TO  ORC-DBYMD(1:6)
           MOVE    WRK-DD              TO  ORC-DBYMD(7:2)
      *
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "DBFETCH"           TO  MCP-FUNC
               MOVE    "TENSU-KEY"         TO  ORC-DBPATH
               CALL    "ORCMCPSUB"          USING
                                            MCPAREA
                                            ORCMCPAREA
                                            MCPDATA-REC
               IF      MCP-RC              =   ZERO
                   MOVE    MCPDATA-REC         TO  TNS-TENSU-REC
                   MOVE    ZERO                TO  FLG-TENSU
               ELSE
                   INITIALIZE                  TNS-TENSU-REC
                   MOVE    1                   TO  FLG-TENSU
               END-IF
           ELSE
               INITIALIZE                  TNS-TENSU-REC
               MOVE    1                   TO  FLG-TENSU
           END-IF
      *
           MOVE    "DBCLOSE"           TO  MCP-FUNC
           MOVE    "TENSU-KEY"         TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
      *
           .
       910-TENSU-READ-EXT.
           EXIT.
      *
      *****************************************************************
      *    診療行為マスター読込
      *****************************************************************
       920-SRYACT-NEXT-SEC         SECTION.
      *
           MOVE    "DBFETCH"           TO  MCP-FUNC
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    MCPDATA-REC         TO  SRYACT-REC
               MOVE    ZERO                TO  FLG-SRYACT
           ELSE
               INITIALIZE                      SRYACT-REC
               MOVE    1                   TO  FLG-SRYACT
           END-IF
      *
           .
       920-SRYACT-NEXT-EXT.
           EXIT.
      *****************************************************************
      *    診療会計マスター読込
      *****************************************************************
       930-SRYACCT-READ-SEC         SECTION.
      *
           MOVE    "DBFETCH"           TO  MCP-FUNC
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    MCPDATA-REC         TO  SRYACCT-REC
               MOVE    ZERO                TO  FLG-SRYACCT
           ELSE
               INITIALIZE                      SRYACCT-REC
               MOVE    1                   TO  FLG-SRYACCT
           END-IF
      *
           .
       930-SRYACCT-READ-EXT.
           EXIT.
      *
      *****************************************************************
      *    入院診療会計マスター読込
      *****************************************************************
       930-NYUINACCT-READ-SEC         SECTION.
      *
           MOVE    "DBFETCH"           TO  MCP-FUNC
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    MCPDATA-REC         TO  NYUINACCT-REC
               MOVE    ZERO                TO  FLG-NYUINACCT
           ELSE
               INITIALIZE                      NYUINACCT-REC
               MOVE    1                   TO  FLG-NYUINACCT
           END-IF
      *
           .
       930-NYUINACCT-READ-EXT.
           EXIT.
      *
      *****************************************************************
      *    患者マスター読込
      *****************************************************************
       940-PTINF-READ-SEC         SECTION.
      *
           MOVE    PTINF-REC           TO  MCPDATA-REC
           MOVE    "DBSELECT"          TO  MCP-FUNC
           MOVE    "PTINF-KEY"         TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    "DBFETCH"           TO  MCP-FUNC
               MOVE    "PTINF-KEY"         TO  ORC-DBPATH
               CALL    "ORCMCPSUB"          USING
                                            MCPAREA
                                            ORCMCPAREA
                                            MCPDATA-REC
               IF      MCP-RC              =   ZERO
                   MOVE    MCPDATA-REC        TO  PTINF-REC
                   MOVE    ZERO               TO  FLG-PTINF
               ELSE
                   MOVE    1                  TO  FLG-PTINF
               END-IF
           ELSE
               MOVE    1              TO  FLG-PTINF
           END-IF
      *
           MOVE    "DBCLOSE"           TO  MCP-FUNC
           MOVE    "PTINF-KEY"         TO  ORC-DBPATH
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
      *
           .
       940-PTINF-READ-EXT.
           EXIT.
      *
      *
      *****************************************************************
      *    入院履歴マスター読込
      *****************************************************************
       910-PTNYUINRRK-READ-SEC         SECTION.
      *
           MOVE    "DBFETCH"           TO  MCP-FUNC
           CALL    "ORCMCPSUB"          USING
                                        MCPAREA
                                        ORCMCPAREA
                                        MCPDATA-REC
           IF      MCP-RC              =   ZERO
               MOVE    MCPDATA-REC     TO  PTNYUINRRK-REC
               MOVE    ZERO            TO  FLG-PTNYUINRRK
           ELSE
               INITIALIZE                  PTNYUINRRK-REC
               MOVE    1               TO  FLG-PTNYUINRRK
           END-IF
      *
           .
       910-PTNYUINRRK-READ-EXT.
           EXIT.
      *
