include $(top_builddir)/Makefile.directories

COBOL = @COBC@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
CC = @CC@
HOSP = @HOSP@
have_jconv = @have_jconv@
JCONV_LIB = @JCONV_LIB@
have_qrencode = @have_qrencode@
QRENCODE_LIB = @QRENCODE_LIB@
PNG_CFLAGS = @png_CFLAGS@
PNG_LIBS = @png_LIBS@

COBCOPYS = -I$(srcdir)/../../cobol/copy

COBOLFLAGS = @COBOLFLAGS@
EXEC_COBOLFLAGS = @EXEC_COBOLFLAGS@
DEPDIR = .deps

OBJS = ${SRCS:.CBL=.so}
EXEC = ${EXEC_SRCS:.CBL=}
COBJS = ${CSRCS:.c=.so}
CJOBJS = ${CJSRCS:.c=.so}  
CJQOBJS = ${CJQSRCS:.c=.so}  

define postprocess-depend
@if test ! -d $(DEPDIR); then mkdir $(DEPDIR); fi
endef

ifeq ($(have_jconv), yes)
  COBJS += $(CJOBJS)
  orcsjistoeuc.so: orcsjistoeuc.c
	$(CC) $(JCONV_LIB) -fPIC -shared $< -o $@
  ifeq ($(have_qrencode), yes)
    COBJS += $(CJQOBJS)
    orcqrencode.so: orcqrencode.c
	$(CC) $(JCONV_LIB) $(QRENCODE_LIB) $(PNG_CFLAGS) $(PNG_LIBS) -fPIC -shared $< -o $@
  endif
endif


%.so: %.c
	$(CC) -fPIC -shared $< -o $@

%.so: %.CBL
	$(postprocess-depend)
	$(COBOL) $(COBOLFLAGS)  $(COBCOPYS)  -MT $@ -MF $(DEPDIR)/${@:.so=.Po} $< 
	
%: %.CBL
	$(postprocess-depend)
	$(COBOL) $(EXEC_COBOLFLAGS) $(COBCOPYS) -MT $@ -MF $(DEPDIR)/${@:=.Po} $<

all: $(COBJS) $(OBJS) $(EXEC)
	@echo $(COBJS) 
	
clean: 
	-rm -f $(COBJS) $(OBJS) $(EXEC)

distclean: 
	-rm -f $(COBJS) $(OBJS) $(EXEC)
	-rm -R $(DEPDIR)

-include $(wildcard $(DEPDIR)/*.Po) /dev/null

filecheck:
	@(for i in $(SRCS) $(CSRCS) $(EXEC_SRCS) ;do echo "make	$${i}"; done ;\
	find . \
	-name "." -o \
	-name "CVS" -prune -o \
	-name ".deps" -prune -o \
	-name "Makefile*" -o \
	-name ".cvsignore" -o \
	-name "*.bak" -o \
	-name "*.so" -o \
	-name "ORCXSMST1" -o \
	-name "ORCGM00.CBL.in" -o \
	-name "kanaconv.h" -o \
	-printf "file\t%f\n") \
	|sort +1 |uniq -u -f1 

install: all installdirs
	for f in $(COBJS) $(OBJS) $(EXEC); do \
	  $(INSTALL) -m 555 $${f} $(orcalibdir) ; done

installdirs:
	$(INSTALL) -d $(orcalibdir)
