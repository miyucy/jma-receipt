#!/bin/bash
#
# jma-receipt ver5.1.0
# 
# バージョンアップによる移行処理
#
# 移行処理対象のテーブルのバックアップについて
#   /var/tmp/jma-migrate-v51 に保存

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

LOG=${LOGDIR}/jma-migrate-v51.log
TDDIR=/var/tmp/jma-migrate-v51

export PATH=${PATCHSCRIPTSDIR}/tools:${SCRIPTSDIR}/tools:${PATCHSCRIPTSDIR}/allways:${SCRIPTSDIR}/allways:${PATH}
su - ${ORCAUSER} -c "echo \"処理を開始しました : $(date '+%Y-%m-%d %H:%M:%S')\" | tee -a ${LOG}"
create_pgpass
# tbl_mstkanri_orgテーブルの存在確認
# テーブルが存在しない場合は移行処理済みと判断する
TABLE=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} ${DBNAME} -Atc \"select relname from pg_class where relname='tbl_mstkanri_org';\""`
if ! [ "${TABLE}" = "tbl_mstkanri_org" ]; then
  # テーブルが存在しない場合は移行元のテーブルを削除する
  su - ${ORCAUSER} -c "psql ${DBCONNOPTION} ${DBNAME} -Atqc \"
    drop table if exists tbl_adrs_org;
    drop table if exists tbl_chk_org;
    drop table if exists tbl_hknjainf_org;
    drop table if exists tbl_srycdchg_org;
    drop table if exists tbl_tensu_org;\""
  su - ${ORCAUSER} -c "echo \"tbl_mstkanri_org テーブルはありません。\" | tee -a ${LOG}"
  su - ${ORCAUSER} -c "echo \"処理を終了します。\" | tee -a ${LOG}"
  delete_pgpass
  exit 0
fi

# 移行前の該当テーブルをバックアップ（１回のみ）
if ! [ -d ${TDDIR} ]; then
  su - ${ORCAUSER} -c "echo \"該当テーブルをバックアップします。[${TDDIR}]\" | tee -a ${LOG}"
  su - ${ORCAUSER} -c "mkdir -p ${TDDIR}"
  su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_mstkanri_org ${DBNAME} > ${TDDIR}/tbl_mstkanri_org.dump"
  su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_adrs_org ${DBNAME} > ${TDDIR}/tbl_adrs_org.dump"
  su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_chk_org ${DBNAME} > ${TDDIR}/tbl_chk_org.dump"
  su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_hknjainf_org ${DBNAME} > ${TDDIR}/tbl_hknjainf_org.dump"
  su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_srycdchg_org ${DBNAME} > ${TDDIR}/tbl_srycdchg_org.dump"
  su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_tensu_org ${DBNAME} > ${TDDIR}/tbl_tensu_org.dump"
fi

# 標準テーブルのマスタ更新（データ移行対象マスタのみ）
su - ${ORCAUSER} -c "echo \"標準テーブルのマスタ更新処理を行います。\" | tee -a ${LOG}"
EXSH=`type -P migrate-v51_master_upgrade_ctrl.sh`
su - ${ORCAUSER} -c "bash ${EXSH}"

# 各テーブルの移行処理
su - ${ORCAUSER} -c "echo \"移行対象テーブルの移行処理を行います。\" | tee -a ${LOG}"
EXSH=`type -P migrate-v51_migrate_ctrl.sh`
su - ${ORCAUSER} -c "bash ${EXSH}"

# 移行処理完了のためテーブルは削除
# マスタ管理テーブルは一応別名でバックアップしておく
su - ${ORCAUSER} -c "pg_dump -Fc -t tbl_mstkanri_org ${DBNAME} > ${TDDIR}/tbl_mstkanri_org_after.dump"
su - ${ORCAUSER} -c "psql ${DBCONNOPTION} ${DBNAME} -Atqc \"
  drop table if exists tbl_mstkanri_org;
  drop table if exists tbl_adrs_org;
  drop table if exists tbl_chk_org;
  drop table if exists tbl_hknjainf_org;
  drop table if exists tbl_srycdchg_org;
  drop table if exists tbl_tensu_org;\""
delete_pgpass
su - ${ORCAUSER} -c "echo \"移行対象テーブルを削除しました。\" | tee -a ${LOG}"
su - ${ORCAUSER} -c "echo \"処理は終了しました : $(date '+%Y-%m-%d %H:%M:%S')\" | tee -a ${LOG}"

exit 0
